# 阶段7 - K1/K2/K3_EN 外部中断控制测试指导

## 📋 测试目标

验证 **K1_EN / K2_EN / K3_EN** 三个外部中断引脚对继电器通道的控制功能，确保：
- 低电平（LOW）触发对应通道**打开**
- 高电平（HIGH）触发对应通道**关闭**
- 三通道互锁逻辑正常工作
- 中断响应及时准确

---

## 🔌 硬件连接

### 1. 控制引脚定义

| 信号名称 | MCU引脚 | 功能描述 | 有效电平 |
|---------|---------|----------|---------|
| **K1_EN** | PB9 | 通道1使能控制 | LOW=打开, HIGH=关闭 |
| **K2_EN** | PB8 | 通道2使能控制 | LOW=打开, HIGH=关闭 |
| **K3_EN** | PA15 | 通道3使能控制 | LOW=打开, HIGH=关闭 |

### 2. 测试连接方式

#### 方法A：使用跳线帽（推荐）

在开发板上为每个 EN 引脚准备跳线座：
```
PB9 (K1_EN)  ──┬── GND (0V)
               └── 3.3V

PB8 (K2_EN)  ──┬── GND (0V)
               └── 3.3V

PA15 (K3_EN) ──┬── GND (0V)
               └── 3.3V
```

**操作说明：**
- 插向 **GND**：触发通道**打开**
- 插向 **3.3V**：触发通道**关闭**

#### 方法B：使用按键开关

如果硬件上已接按键：
```
            +3.3V
              │
             ┌┴┐
        10K  │ │ 上拉电阻
             └┬┘
              ├─────→ PB9/PB8/PA15
              │
            ┌─┴─┐
        SW  │   │ 按键
            └─┬─┘
              │
             GND
```

**操作说明：**
- **不按**按键（上拉）：引脚为 **HIGH**，通道关闭
- **按下**按键（接地）：引脚为 **LOW**，通道打开

---

## 🧪 测试步骤

### 步骤1：硬件准备

1. **连接调试工具**
   - ST-Link 连接到 MCU SWD 接口
   - USB转串口连接到 USART1（PA9/PA10）
   - 波特率设置为 **115200**

2. **初始状态设置**
   - 将所有 EN 引脚默认连接到 **3.3V（HIGH）**
   - 确保继电器供电正常
   - 准备万用表或示波器测量继电器控制引脚

3. **上电启动**
   - 烧录程序后复位MCU
   - 观察串口输出初始化信息

---

### 步骤2：查看初始化信息

串口应输出以下内容：

```
========== Phase 7 Test ==========
Testing relay control module...

========== External Interrupt Test Mode ==========
Testing K1_EN/K2_EN/K3_EN interrupt control...

[Instructions]
  K1_EN (PB9):  LOW=Open CH1,  HIGH=Close CH1
  K2_EN (PB8):  LOW=Open CH2,  HIGH=Close CH2
  K3_EN (PA15): LOW=Open CH3,  HIGH=Close CH3

[Hardware Setup]
  - Connect K1_EN/K2_EN/K3_EN to GND (LOW) or 3.3V (HIGH)
  - Use jumper or switch to change levels
  - Observe serial output and relay actions

[Status Monitor Started - Change EN pins to test]
```

**✅ 确认点：**
- 串口输出清晰完整
- 所有继电器控制引脚初始为高电平
- 无继电器动作（初始静态）

---

### 步骤3：测试通道1（K1_EN / PB9）

#### 测试3.1：打开通道1

1. **操作：将 PB9 连接到 GND**（LOW）

2. **预期现象：**

   **串口输出：**
   ```
   [ISR] K1_EN interrupt triggered, opening CH1...
   [Relay] Opening CH1...
   [FSM] CH1 Relay1 starting ON pulse
   [FSM] CH1 Relay2 starting ON pulse
   ```

   **硬件现象：**
   - PC0 (K1_1_ON) 输出 **500ms 低电平脉冲**
   - PA12 (K1_2_ON) 输出 **500ms 低电平脉冲**
   - 听到继电器 **K1.1 和 K1.2 吸合声**（"咔嗒"两声）
   - LED 或指示灯显示 CH1 激活

   **测量验证：**
   - 用示波器测量 PC0：应看到 500ms 低电平脉冲
   - 用示波器测量 PA12：应看到 500ms 低电平脉冲
   - 脉冲结束后，引脚恢复高电平

#### 测试3.2：关闭通道1

1. **操作：将 PB9 连接到 3.3V**（HIGH）

2. **预期现象：**

   **串口输出：**
   ```
   [ISR] K1_EN interrupt triggered, closing CH1...
   [Relay] Closing CH1...
   [FSM] CH1 Relay1 starting OFF pulse
   [FSM] CH1 Relay2 starting OFF pulse
   ```

   **硬件现象：**
   - PC1 (K1_1_OFF) 输出 **500ms 低电平脉冲**
   - PA3 (K1_2_OFF) 输出 **500ms 低电平脉冲**
   - 听到继电器 **K1.1 和 K1.2 释放声**
   - LED 或指示灯熄灭

**✅ 通道1测试通过标准：**
- [ ] PB9 低电平触发打开
- [ ] PB9 高电平触发关闭
- [ ] 500ms 脉冲时序正确
- [ ] 继电器动作声音清晰
- [ ] 串口输出与实际一致

---

### 步骤4：测试通道2（K2_EN / PB8）

#### 测试4.1：打开通道2（验证互锁）

**前置条件：通道1已打开**

1. **操作：将 PB8 连接到 GND**（LOW）

2. **预期现象：**

   **串口输出：**
   ```
   [ISR] K2_EN interrupt triggered, opening CH2...
   [Interlock] Closing CH1 before opening CH2...
   [Relay] Closing CH1...
   [FSM] CH1 Relay1 starting OFF pulse
   [FSM] CH1 Relay2 starting OFF pulse
   [Relay] Opening CH2...
   [FSM] CH2 Relay1 starting ON pulse
   [FSM] CH2 Relay2 starting ON pulse
   ```

   **硬件现象：**
   - **先听到 CH1 继电器释放声**（"咔嗒"两声）
   - 延迟约 500ms 后
   - **再听到 CH2 继电器吸合声**（"咔嗒"两声）
   - CH1 LED 熄灭，CH2 LED 点亮

   **测量验证：**
   - PC2 (K2_1_ON) 输出 500ms 低电平脉冲
   - PA4 (K2_2_ON) 输出 500ms 低电平脉冲

**✅ 互锁测试通过标准：**
- [ ] CH1 自动关闭
- [ ] CH2 成功打开
- [ ] 两个通道不会同时激活
- [ ] 时序正确（先关后开）

#### 测试4.2：关闭通道2

1. **操作：将 PB8 连接到 3.3V**（HIGH）

2. **预期现象：** 与通道1关闭类似

---

### 步骤5：测试通道3（K3_EN / PA15）

#### 测试5.1：打开通道3

1. **操作：将 PA15 连接到 GND**（LOW）

2. **预期现象：**
   - 如果 CH2 正在运行，会先自动关闭
   - CH3 继电器吸合
   - PC7/PD2 输出 500ms 脉冲

#### 测试5.2：关闭通道3

1. **操作：将 PA15 连接到 3.3V**（HIGH）

2. **预期现象：** 与通道1、2关闭类似

**✅ 通道3测试通过标准：**
- [ ] PA15 低电平触发打开
- [ ] PA15 高电平触发关闭
- [ ] 互锁逻辑正常
- [ ] 继电器动作正常

---

### 步骤6：快速切换测试

测试中断响应速度和互锁可靠性：

1. **操作：快速连续改变 EN 引脚状态**
   ```
   PB9: HIGH→LOW  (打开CH1)
   等待1秒
   PB8: HIGH→LOW  (切换到CH2)
   等待1秒
   PA15: HIGH→LOW (切换到CH3)
   等待1秒
   PA15: LOW→HIGH (关闭CH3)
   ```

2. **预期现象：**
   - 每次切换都能正确响应
   - 互锁逻辑始终有效
   - 不会出现多个通道同时激活
   - 串口输出连续清晰

**✅ 快速切换测试通过标准：**
- [ ] 响应速度 < 10ms
- [ ] 无误触发或漏触发
- [ ] 互锁始终有效
- [ ] 无程序卡死或异常

---

## 📊 测试记录表

| 测试项 | 引脚 | 操作 | 预期结果 | 实际结果 | 通过 |
|--------|------|------|----------|----------|------|
| CH1打开 | PB9 | HIGH→LOW | K1.1/K1.2吸合 | | ☐ |
| CH1关闭 | PB9 | LOW→HIGH | K1.1/K1.2释放 | | ☐ |
| CH2打开（互锁） | PB8 | HIGH→LOW | CH1关闭，CH2打开 | | ☐ |
| CH2关闭 | PB8 | LOW→HIGH | K2.1/K2.2释放 | | ☐ |
| CH3打开（互锁） | PA15 | HIGH→LOW | CH2关闭，CH3打开 | | ☐ |
| CH3关闭 | PA15 | LOW→HIGH | K3.1/K3.2释放 | | ☐ |
| 快速切换 | 全部 | 连续切换 | 响应正常无误 | | ☐ |

---

## 🔍 故障排查

### 问题1：EN引脚电平改变，但无继电器动作

**可能原因：**
1. 外部中断未启用
2. NVIC优先级配置错误
3. 引脚接触不良

**排查步骤：**
```c
// 在 relay_control.c 的 ISR 函数开头添加调试输出
void Relay_K1_EN_ISR(void) {
    printf("[DEBUG] K1_EN ISR entered\r\n");  // 添加这一行
    // ... 原有代码
}
```
- 如果看不到 `[DEBUG]` 输出，说明中断未触发
- 检查 CubeMX 中 PB9/PB8/PA15 是否配置为 **GPIO_EXTI** 模式
- 检查 NVIC 中对应 EXTI 线是否使能

### 问题2：中断触发，但继电器不动作

**可能原因：**
1. 继电器供电不足
2. GPIO 配置错误
3. 脉冲时序异常

**排查步骤：**
1. 用万用表测量继电器驱动电压
2. 用示波器测量控制引脚波形
3. 检查 `Relay_Update()` 是否在主循环中持续调用

### 问题3：互锁失效，多个通道同时激活

**可能原因：**
1. 状态管理混乱
2. 中断优先级冲突
3. 代码逻辑错误

**排查步骤：**
1. 在 `Relay_OpenChannel()` 中添加调试输出
2. 检查 `relay_manager.active_channel` 变量
3. 确认互锁逻辑在中断中正确执行

### 问题4：串口输出异常或乱码

**可能原因：**
1. 波特率不匹配
2. UART 初始化失败
3. printf 重定向问题

**排查步骤：**
1. 确认串口助手波特率为 **115200**
2. 检查 USART1 初始化代码
3. 确认 `usart.c` 中 `fputc` 重定向实现

---

## ✅ 验收标准

### 必须通过（P0）

- [ ] **中断响应**：EN 引脚电平改变后，10ms 内触发相应动作
- [ ] **互锁逻辑**：任意时刻最多只有一个通道激活
- [ ] **脉冲时序**：所有继电器控制脉冲宽度为 500ms±10ms
- [ ] **静态电平**：控制引脚在非脉冲期间保持高电平
- [ ] **串口输出**：实时反映系统状态，无乱码

### 建议通过（P1）

- [ ] **快速切换**：连续切换通道时响应准确无误
- [ ] **长时间运行**：连续运行 30 分钟无异常
- [ ] **声音识别**：凭继电器声音可判断动作类型

### 可选测试（P2）

- [ ] **状态反馈**：读取继电器和接触器状态反馈信号（需要硬件接线）
- [ ] **防抖测试**：人为制造抖动信号，验证防抖逻辑
- [ ] **异常恢复**：断电重启后系统状态正确

---

## 📝 测试结论

**测试日期：** ____________________

**测试人员：** ____________________

**测试结果：** ☐ 通过  ☐ 部分通过  ☐ 未通过

**问题记录：**

```
（记录遇到的问题及解决方法）




```

**改进建议：**

```
（对代码或硬件的改进建议）




```

---

## 🎯 下一步工作

完成本阶段测试后，可以进行：

1. **阶段7扩展**：测试状态反馈和防抖功能
2. **系统集成测试**：验证所有模块协同工作
3. **性能优化**：减少响应延迟，优化代码结构
4. **现场测试**：在实际应用环境中验证可靠性

---

**文档版本：** v1.0  
**更新日期：** 2026-02-13  
**文档编码：** UTF-8
