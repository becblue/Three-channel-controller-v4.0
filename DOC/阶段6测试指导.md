# 阶段6测试指导：报警输出控制模块

## 📋 测试目标

验证报警输出控制模块的以下功能：
1. ALARM引脚控制（有异常时输出低电平）
2. 蜂鸣器分级控制（持续/50ms脉冲/1秒脉冲）
3. 异常标志位图管理（16位）
4. 多异常优先级处理

---

## 🔌 硬件连接

### GPIO引脚配置
| 信号 | 引脚 | 方向 | 说明 |
|------|------|------|------|
| ALARM | PB4 | 输出 | 低电平有效（任何异常时输出低电平）|
| BEEP | PB3 | 输出 | 低电平有效（蜂鸣器控制）|

### 测试设备
- **LED指示灯**：连接到PB4（ALARM），观察异常状态
- **蜂鸣器**：连接到PB3（BEEP），观察报警声音
- **串口调试工具**：115200-8-N-1，查看测试日志

---

## 📝 测试步骤

### 测试1：A类异常（1秒脉冲）

**测试目的**：验证冲突/自检类异常的蜂鸣器模式

**操作步骤**：
1. 烧录程序后重启系统
2. 系统自动执行Phase 6测试
3. 观察串口输出：`[Test 1] A类异常 - 1秒脉冲测试`

**预期现象**：
- ✅ ALARM引脚输出低电平（LED亮）
- ✅ 蜂鸣器以**1秒间隔脉冲**响（1秒响+1秒静）
- ✅ 串口输出异常标志：`0x0001`
- ✅ 5秒后清除异常，ALARM和BEEP恢复高电平

---

### 测试2：B类异常（50ms脉冲）

**测试目的**：验证状态反馈类异常的蜂鸣器模式

**操作步骤**：
1. 继续观察测试2
2. 串口输出：`[Test 2] B类异常 - 50ms脉冲测试`

**预期现象**：
- ✅ ALARM引脚输出低电平（LED亮）
- ✅ 蜂鸣器以**50ms间隔脉冲**响（50ms响+50ms静，声音快速）
- ✅ 串口输出异常标志：`0x0002`
- ✅ 2秒后清除异常，ALARM和BEEP恢复高电平

---

### 测试3：K类异常（持续响）

**测试目的**：验证温度类异常的蜂鸣器模式

**操作步骤**：
1. 继续观察测试3
2. 串口输出：`[Test 3] K类异常 - 持续响测试`

**预期现象**：
- ✅ ALARM引脚输出低电平（LED亮）
- ✅ 蜂鸣器**持续响**（不间断）
- ✅ 串口输出异常标志：`0x0400`
- ✅ 5秒后清除异常，ALARM和BEEP恢复高电平

---

### 测试4：多异常优先级测试

**测试目的**：验证异常优先级机制

**操作步骤**：
1. 继续观察测试4
2. 串口输出：`[Test 4] 多异常优先级测试`

**测试流程**：
- **步骤1**：设置A类异常（1秒脉冲）
  - 预期：蜂鸣器1秒间隔脉冲
- **步骤2**：再设置B类异常（50ms脉冲）
  - 预期：蜂鸣器切换到50ms脉冲（B优先级 > A）
- **步骤3**：再设置K类异常（持续响）
  - 预期：蜂鸣器切换到持续响（K优先级最高）

**优先级规则**：
```
温度异常（K~M）> 状态反馈异常（B~J）> 冲突/自检异常（A、N、O）
```

**预期现象**：
- ✅ 每次设置新异常，蜂鸣器模式正确切换
- ✅ 串口输出显示多个异常共存
- ✅ 最终清除所有异常后，ALARM和BEEP恢复高电平

---

## 📊 串口输出示例

```
========== Phase 6 Test ==========
测试报警输出控制模块...

[Alarm] 模块初始化完成
[Alarm] ALARM引脚: PB4（高电平=正常）
[Alarm] BEEP引脚:  PB3（高电平=静音）

[Test 1] A类异常 - 1秒脉冲测试
[Alarm] 设置异常: 0x0001 (A-Enable Conflict)
[Alarm] 蜂鸣器模式切换: 0 -> 3

========================================
          报警状态
========================================
异常标志: 0x0001
  活动异常列表:
    - A-Enable Conflict

蜂鸣器模式: 1秒脉冲（冲突/自检异常）

GPIO状态:
  ALARM: 低电平（报警）
  BEEP:  响
========================================

  [1] 蜂鸣器应该1秒脉冲...
  [2] 蜂鸣器应该1秒脉冲...
  [3] 蜂鸣器应该1秒脉冲...
  [4] 蜂鸣器应该1秒脉冲...
  [5] 蜂鸣器应该1秒脉冲...
[Alarm] 清除异常: 0x0001 (A-Enable Conflict)
  A类异常已清除

[Test 2] B类异常 - 50ms脉冲测试
[Alarm] 设置异常: 0x0002 (B-K1_1_STA Error)
[Alarm] 蜂鸣器模式切换: 0 -> 2

========================================
          报警状态
========================================
异常标志: 0x0002
  活动异常列表:
    - B-K1_1_STA Error

蜂鸣器模式: 50ms脉冲（状态反馈异常）

GPIO状态:
  ALARM: 低电平（报警）
  BEEP:  响
========================================

  [1] 蜂鸣器应该50ms脉冲...
  [2] 蜂鸣器应该50ms脉冲...
  [3] 蜂鸣器应该50ms脉冲...
  [4] 蜂鸣器应该50ms脉冲...
[Alarm] 清除异常: 0x0002 (B-K1_1_STA Error)
  B类异常已清除

[Test 3] K类异常 - 持续响测试
[Alarm] 设置异常: 0x0400 (K-NTC_1 Temp Error)
[Alarm] 蜂鸣器模式切换: 0 -> 1

========================================
          报警状态
========================================
异常标志: 0x0400
  活动异常列表:
    - K-NTC_1 Temp Error

蜂鸣器模式: 持续响（温度异常）

GPIO状态:
  ALARM: 低电平（报警）
  BEEP:  响
========================================

  [1] 蜂鸣器应该持续响...
  [2] 蜂鸣器应该持续响...
  [3] 蜂鸣器应该持续响...
  [4] 蜂鸣器应该持续响...
  [5] 蜂鸣器应该持续响...
[Alarm] 清除异常: 0x0400 (K-NTC_1 Temp Error)
  K类异常已清除

[Test 4] 多异常优先级测试
  设置A类异常（1秒脉冲）...
[Alarm] 设置异常: 0x0001 (A-Enable Conflict)
[Alarm] 蜂鸣器模式切换: 0 -> 3
  再设置B类异常（50ms脉冲）- 应切换到50ms脉冲...
[Alarm] 设置异常: 0x0002 (B-K1_1_STA Error)
[Alarm] 蜂鸣器模式切换: 3 -> 2
  再设置K类异常（持续响）- 应切换到持续响...
[Alarm] 设置异常: 0x0400 (K-NTC_1 Temp Error)
[Alarm] 蜂鸣器模式切换: 2 -> 1

========================================
          报警状态
========================================
异常标志: 0x0403
  活动异常列表:
    - A-Enable Conflict
    - B-K1_1_STA Error
    - K-NTC_1 Temp Error

蜂鸣器模式: 持续响（温度异常）

GPIO状态:
  ALARM: 低电平（报警）
  BEEP:  响
========================================

  清除所有异常...
[Alarm] 清除所有异常标志

========================================
          报警状态
========================================
异常标志: 0x0000
  无异常

蜂鸣器模式: 关闭

GPIO状态:
  ALARM: 高电平（正常）
  BEEP:  静
========================================

========== Phase 6 Test PASS ==========
```

---

## ✅ 验收标准

### 功能性验收
- [ ] ALARM引脚：有异常时输出低电平，无异常时输出高电平
- [ ] 蜂鸣器模式1：A、N、O类异常触发1秒间隔脉冲
- [ ] 蜂鸣器模式2：B~J类异常触发50ms间隔脉冲
- [ ] 蜂鸣器模式3：K~M类异常触发持续响
- [ ] 多异常优先级：温度 > 状态反馈 > 冲突/自检

### 性能验收
- [ ] 异常设置/清除响应时间 < 10ms
- [ ] 蜂鸣器脉冲周期误差 < 5%
- [ ] 支持同时管理15种异常（位图管理）

### 代码质量验收
- [ ] 所有代码注释使用中文
- [ ] 无编译警告
- [ ] 无linter错误

---

## 🔧 常见问题

### 问题1：蜂鸣器无声音
**可能原因**：
- 蜂鸣器未连接或损坏
- BEEP引脚（PB3）配置错误
- 无源蜂鸣器需要PWM驱动（当前为GPIO控制）

**解决方案**：
- 检查硬件连接
- 用示波器查看PB3输出波形
- 确认使用有源蜂鸣器

### 问题2：ALARM引脚状态不对
**可能原因**：
- GPIO初始化顺序错误
- 引脚复用冲突

**解决方案**：
- 检查`gpio.c`中PB4配置
- 确认无其他模块占用PB4

### 问题3：多异常优先级错误
**可能原因**：
- `alarm_update_beep_mode()`逻辑错误
- 异常分组宏定义错误

**解决方案**：
- 查看串口输出的蜂鸣器模式切换日志
- 验证`ERROR_GROUP_TEMP`等宏定义

---

## 📚 相关模块

- **common_def.h/c**：异常类型定义、蜂鸣器模式枚举
- **main.h**：ALARM/BEEP引脚宏定义
- **gpio.c**：GPIO初始化

---

## 📅 测试记录

| 测试日期 | 测试人员 | 测试结果 | 备注 |
|---------|---------|---------|------|
| 2026-02-12 | AI Assistant | ✅ PASS | 初始开发完成 |
|  |  |  |  |
|  |  |  |  |

---

**测试完成后请确认所有验收标准已满足！** ✅
