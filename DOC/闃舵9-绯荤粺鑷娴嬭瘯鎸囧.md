# 阶段9：应用层 - 系统自检模块 - 测试指导

---

## 测试概述

**测试目标：** 验证上电自检流程（LOGO→Step1~4→PASS/FAIL）的完整逻辑、OLED 进度条显示、继电器纠错能力以及自检结束后安全监控的正常接管。

**测试时间：** 约 20~30 分钟

**测试工具：**
- 串口调试助手（波特率 115200）
- 跳线若干
- 示波器（可选，用于验证继电器脉冲）

**自检总耗时：** 约 6 秒（LOGO 2s + 四步检测 2.5s + 结果显示 1.5s）

---

## 硬件连接说明

### K_EN 使能信号

| 信号 | 引脚 | 说明 |
|------|------|------|
| **K1_EN** | PB9 | 跳线接 GND（LOW=期望打开）或 3.3V（HIGH=期望关闭） |
| **K2_EN** | PB8 | 同上 |
| **K3_EN** | PA15 | 同上 |

> **电平规则：** K_EN = LOW → 通道期望打开（继电器吸合，STA 应为 HIGH）
> K_EN = HIGH → 通道期望关闭（继电器断开，STA 应为 LOW）

### 继电器状态反馈（Step2 验证用）

| 信号 | 引脚 | 初始状态 | 说明 |
|------|------|---------|------|
| K1_1_STA | PC4 | LOW（内部下拉） | 继电器1路1状态 |
| K2_1_STA | PC5 | LOW | 继电器2路1状态 |
| K3_1_STA | PB0 | LOW | 继电器3路1状态 |

### 接触器状态反馈（Step3 验证用）

| 信号 | 引脚 | 初始状态 | 说明 |
|------|------|---------|------|
| SW1_STA | PA8 | LOW（内部下拉） | 接触器1状态 |
| SW2_STA | PC9 | LOW | 接触器2状态 |
| SW3_STA | PC8 | LOW | 接触器3状态 |

---

## 测试前准备

1. **全部 K_EN 置为 HIGH（3.3V）**：模拟上电初始状态（所有通道关闭）
2. **STA 引脚保持默认（LOW）**：与 K_EN=HIGH 的期望一致，无需纠错
3. **上电并打开串口调试助手**（波特率 115200，8N1）
4. OLED 屏幕处于可见位置

---

## 测试一：正常上电自检（全部关闭，自检通过）

### 硬件条件
- K1_EN = K2_EN = K3_EN = HIGH（3.3V）
- 所有 STA 引脚 = LOW（默认）
- 温度正常（室温，远低于 60°C）

### 预期串口输出

```
========== Phase 9: Self Test ==========
[SelfTest] Starting self-test sequence...
[SelfTest] Showing LOGO (2000ms)...
[SelfTest] Step1: State identify
[SelfTest] Step1 PASS: Expected open CH=0
[SelfTest] Step2: Relay correction
[SelfTest] Step2 PASS: All relay states correct
[SelfTest] Step3: Switch check
[SelfTest] Step3 PASS: All switch states correct
[SelfTest] Step4: Temperature check
[SelfTest] Step4 PASS: Temperature normal
[SelfTest] *** SELF TEST PASS ***
[SelfTest] Result: PASS
  Step1 State Identify : PASS
  Step2 Relay Correct  : PASS
  Step3 Switch Check   : PASS
  Step4 Temp Check     : PASS
```

### 预期 OLED 显示时序

| 时间 | OLED 内容 |
|------|-----------|
| 0 ~ 2s | 公司 LOGO（居中显示） |
| 2 ~ 2.5s | "Self Testing..." + "Step1:State Check" + 进度条 0%→25% |
| 2.5 ~ 3.3s | "Step2:Relay Check" + 进度条 25%→50% |
| 3.3 ~ 3.8s | "Step3:SwitchCheck" + 进度条 50%→75% |
| 3.8 ~ 4.5s | "Step4:Temp Check" + 进度条 75%→100% |
| 4.5 ~ 6s | "Self Test" + "PASS"（8x16 大字） |

### 验收标准
- [ ] 串口四步全部输出 PASS
- [ ] OLED 进度条平滑从 0% 增长到 100%，无闪烁
- [ ] OLED 最终显示 "PASS" 大字
- [ ] 自检结束约 100ms 后，Safety_Update 正常运行

---

## 测试二：上电时通道一已打开（Step2 无需纠错）

### 硬件条件
- **K1_EN = LOW（GND）**：期望通道1打开
- K2_EN = K3_EN = HIGH（3.3V）
- **K1_1_STA = HIGH（用跳线接 3.3V）**：继电器已吸合，与期望一致
- **SW1_STA = HIGH（用跳线接 3.3V）**：接触器已闭合，与期望一致

### 预期串口输出

```
[SelfTest] Step1 PASS: Expected open CH=1
[SelfTest] Step2: Relay correction
[SelfTest] Step2 PASS: All relay states correct
[SelfTest] Step3: Switch check
[SelfTest] Step3 PASS: All switch states correct
[SelfTest] *** SELF TEST PASS ***
```

### 说明
Step2 检查 K1_1_STA 为 HIGH，与期望（K1_EN=LOW → 应打开 → STA=HIGH）一致，不发起脉冲，直接通过。

---

## 测试三：继电器状态不符（Step2 纠错功能验证）

### 硬件条件
- **K1_EN = LOW（GND）**：期望通道1打开
- K2_EN = K3_EN = HIGH
- **K1_1_STA = LOW（默认，未吸合）**：与期望不符，触发纠错

### 预期串口输出（未连接实际继电器）

```
[SelfTest] Step1 PASS: Expected open CH=1
[SelfTest] Step2: Relay correction
[SelfTest] Step2: CH1 should be OPEN, sending ON pulse
[Relay] Opening CH1...
（等待 800ms 后）
[SelfTest] Step2 FAIL: CH1 K_1_STA mismatch (expected HIGH, got LOW)
[SelfTest] *** SELF TEST FAIL ***
```

### 预期串口输出（已连接实际继电器且动作成功）

```
[SelfTest] Step2: CH1 should be OPEN, sending ON pulse
（等待 800ms 后，K1_1_STA 已变 HIGH）
[SelfTest] Step2 PASS: All relay states correct
[SelfTest] *** SELF TEST PASS ***
```

---

## 测试四：接触器状态异常（Step3 失败验证）

### 硬件条件
- K1_EN = LOW，K1_1_STA = HIGH（跳线模拟继电器正确吸合）
- **SW1_STA = LOW（不接 3.3V）**：接触器未闭合，与期望不符

### 预期串口输出

```
[SelfTest] Step3 FAIL: CH1 SW_STA mismatch (expected HIGH, got LOW)
[SelfTest] *** SELF TEST FAIL ***
[SelfTest] Result: FAIL
  Step1 State Identify : PASS
  Step2 Relay Correct  : PASS
  Step3 Switch Check   : FAIL
  Step4 Temp Check     : PASS
```

---

## 测试五：上电使能冲突（Step1 失败验证）

### 硬件条件
- **K1_EN = K2_EN = LOW（GND）**：两路同时使能 → 使能冲突

### 预期串口输出

```
[SelfTest] Step1 FAIL: Enable conflict (2 channels enabled)
[SelfTest] Step2 SKIP: Step1 failed, no correction
[SelfTest] *** SELF TEST FAIL ***
[SelfTest] Result: FAIL
  Step1 State Identify : FAIL
  Step2 Relay Correct  : FAIL
  Step3 Switch Check   : PASS
  Step4 Temp Check     : PASS
```

### 说明
Step1 失败后 Step2 自动跳过，防止在冲突状态下误操作继电器。

---

## 测试六：自检通过后安全监控接管验证

### 步骤
1. 按测试一条件正常上电，等待自检通过（约 6 秒）
2. 观察自检结束后串口输出
3. 将 K1_EN 拉低（接 GND），验证继电器控制正常

### 预期现象

```
（自检通过约 100ms 后，Safety_Update 开始轮询，无异常时无额外输出）

（K1_EN 拉低后）
[ISR] K1_EN interrupt triggered, opening CH1...
[Relay] Opening CH1...
```

---

## 测试七：自检期间无误报警验证

### 步骤
在自检运行的 6 秒内，观察串口是否有 `[Alarm] Set error` 输出。

### 验收标准
自检运行期间**不允许**出现任何 Alarm Set error 输出。

---

## 故障排除

### 问题1：自检结束后 Safety_Update 无输出
**排查：** 确认串口已输出 `*** SELF TEST PASS ***` 或 `FAIL`，再等待 1.5 秒后观察。检查 main.c 主循环 else 分支是否正常执行。

### 问题2：Step2 纠错脉冲未发出
**排查：** 检查串口是否出现 `Step2: CH? should be OPEN/CLOSED, sending pulse`。若未出现，检查 Relay_IsChannelBusy() 的状态。

### 问题3：OLED 进度条不更新
**排查：** 确认阶段5 OLED 测试已通过，检查 PB6（SCL）、PB7（SDA）连接。

### 问题4：Step4 总是失败（温度误报）
**排查：** 检查 NTC 传感器是否脱落（脱落会导致 ADC 读数异常触发过温）。

---

## 测试记录表

| 测试项目 | 结果 | 备注 |
|---------|------|------|
| LOGO 显示（2秒） | PASS / FAIL | |
| OLED 进度条平滑更新（0%→100%） | PASS / FAIL | |
| Step1：全关闭正常通过 | PASS / FAIL | |
| Step1：使能冲突正确检测 | PASS / FAIL | |
| Step2：状态一致时无纠错 | PASS / FAIL | |
| Step2：状态不符时纠错脉冲发出 | PASS / FAIL | |
| Step3：接触器正常时通过 | PASS / FAIL | |
| Step3：接触器异常时失败 | PASS / FAIL | |
| Step4：温度正常时通过 | PASS / FAIL | |
| OLED 显示 PASS / FAIL 大字 | PASS / FAIL | |
| 自检 PASS 时无 N 类报警 | PASS / FAIL | |
| 自检 FAIL 时 N 类报警触发 | PASS / FAIL | |
| 自检结束后 Safety_Update 正常接管 | PASS / FAIL | |
| 自检期间零误报警 | PASS / FAIL | |

---

## 验收标准

### 必须满足
- [ ] 正常上电自检 PASS，串口四步全部输出 PASS
- [ ] OLED 进度条从 0% 平滑增长到 100%，无闪烁
- [ ] 自检 PASS 时 OLED 显示 "PASS"，N 类异常不触发
- [ ] 自检 FAIL 时 OLED 显示 "FAIL"，N 类异常（0x2000）触发
- [ ] 使能冲突时 Step1 正确检测失败
- [ ] 继电器状态不符时 Step2 正确发起纠错脉冲
- [ ] 自检结束后 Safety_Update() 正常接管
- [ ] 自检期间无任何误报警

### 性能指标
- **自检总时间：** 约 6 秒（允许 ±200ms 误差）
- **串口输出延迟：** 每步完成后 20ms 内输出
- **OLED 刷新率：** 每 1% 刷新一次

---

## 调试命令参考

```c
SelfTest_PrintResult();    /* 打印自检各步骤结果 */
Safety_PrintStatus();      /* 打印安全监控当前异常 */
Relay_PrintStatus();       /* 打印继电器通道状态 */
```

---

## 测试完成标志

- [x] 正常上电自检 PASS 验证通过
- [x] 四步子检测逻辑全部验证通过
- [x] OLED 进度条和结果显示正确
- [x] 自检 FAIL 时 N 类异常正确触发
- [x] 自检结束后安全监控正常接管
- [x] 自检期间不产生误报警

**完成后可进入阶段10：应用层 - 系统主界面（OLED 运行状态显示）**

---

**文档创建时间：** 2026-02-12
**文档版本：** v1.0
**作者：** Three-channel Controller Team
