# 阶段4测试指导

**测试模块**：温度检测与风扇控制  
**测试日期**：2026-02-12  
**测试版本**：Phase 4  

---

## 一、测试准备

### 1.1 硬件要求

- ✅ STM32F103RCT6核心板
- ✅ 串口调试工具（波特率115200）
- ✅ **3路NTC温度传感器**（10K B3435，已连接至PA0、PA1、PA2）
- ✅ **风扇**（已连接至TIM3_CH1/PA6）
- ✅ **示波器**（可选，用于验证PWM波形）
- ✅ **加热设备**（可选，用于测试温度阈值切换）

### 1.2 软件要求

- ✅ Keil MDK-ARM
- ✅ STM32CubeProgrammer
- ✅ 串口调试助手（支持115200波特率）

### 1.3 编译状态

```
编译结果：0 Error, 0 Warning
代码大小：Code=16168 RO-data=516 RW-data=28 ZI-data=1604
```

---

## 二、测试环境

### 2.1 ADC配置

| 参数 | 配置 |
|------|------|
| ADC通道 | CH0(PA0), CH1(PA1), CH2(PA2) |
| 扫描模式 | 使能 |
| 转换模式 | 连续转换 |
| DMA模式 | 循环模式 |
| 分辨率 | 12位（0-4095） |
| 采样时间 | 55.5 Cycles |

### 2.2 TIM3 PWM配置

| 参数 | 配置 |
|------|------|
| PWM通道 | TIM3_CH1/PA6 |
| 预分频器 | 35（PSC） |
| 自动重装载 | 99（ARR） |
| PWM频率 | 72MHz/(36*100) = 20kHz |
| 初始占空比 | 50%（CCR=50） |

### 2.3 温度阈值

| 阈值 | 温度 | 回差 |
|------|------|------|
| 低温告警 | 35°C | 2°C（33°C恢复） |
| 高温告警 | 60°C | 2°C（58°C恢复） |

### 2.4 风扇控制

| 状态 | 占空比 |
|------|--------|
| 正常速度 | 50% |
| 高速 | 95% |

---

## 三、测试步骤

### 3.1 初始化测试

**测试目的**：验证温度模块初始化是否正常

**预期输出**：
```
[xxx ms] [INFO] Temperature module initialized
ADC+DMA started for 3 NTC channels
Fan PWM started at 50%
Filter size: 8 points
```

**验收标准**：
- ✅ 串口打印初始化信息
- ✅ 风扇开始转动（50%速度）
- ✅ ADC+DMA启动成功

---

### 3.2 温度采集测试（20秒）

**测试目的**：验证3路NTC温度采集与显示

**预期输出**（示例）：
```
=== Temperature Monitoring Test (20s) ===
Time  NTC1(C)  NTC2(C)  NTC3(C)  FAN%  Status
----------------------------------------------------
[ 1s]   24.5     24.3     24.6     50%  ---
[ 2s]   24.4     24.2     24.5     50%  ---
[ 3s]   24.6     24.4     24.7     50%  ---
...
[20s]   24.5     24.3     24.6     50%  ---
```

**验收标准**：
- ✅ 每秒更新一次温度值
- ✅ 3路温度显示正常（误差±2°C）
- ✅ 风扇保持50%速度
- ✅ 状态标志为`---`（正常）

---

### 3.3 滤波器测试

**测试目的**：验证8点移动平均滤波是否生效

**测试方法**：
1. 用手指触摸NTC传感器加热
2. 观察温度变化是否平滑（无突变）

**预期行为**：
- ✅ 温度变化平滑
- ✅ 无剧烈跳变（±1°C以内）

**验收标准**：
- ✅ 滤波器就绪（8次采样后）
- ✅ 温度数据平滑

---

### 3.4 温度状态详情测试

**测试目的**：验证温度状态打印功能

**预期输出**（示例）：
```
========== Temperature Status ==========
NTC Temperatures:
  NTC1:  24.5 C  (ADC: 1980 - Normal)
  NTC2:  24.3 C  (ADC: 1985 - Normal)
  NTC3:  24.6 C  (ADC: 1975 - Normal)

Fan Control:
  Speed: 50% (NORMAL)

Filter Status:
  Filter ready: YES
  Filter index: 3/8
========================================
```

**验收标准**：
- ✅ 显示3路温度、ADC值、状态
- ✅ 显示风扇速度
- ✅ 显示滤波器状态

---

### 3.5 心跳测试

**测试目的**：验证主循环中的温度监控

**预期输出**（每5秒）：
```
[xxx ms] T1: 24.5C T2: 24.3C T3: 24.6C FAN:50% - Phase 4 OK
[xxx ms] T1: 24.6C T2: 24.4C T3: 24.7C FAN:50% - Phase 4 OK
```

**验收标准**：
- ✅ 每5秒更新一次
- ✅ 温度值准确
- ✅ 风扇速度正确

---

### 3.6 温度阈值测试（可选）

⚠️ **需要加热设备，如电烙铁、热风枪等**

#### **测试1：35°C阈值**

**测试步骤**：
1. 将NTC1加热至35°C以上
2. 观察串口输出

**预期输出**：
```
NTC1: Temp reached 35C
[20s]   35.2     24.3     24.6     50%  W--
```

**验收标准**：
- ✅ 温度达到35°C时，打印告警信息
- ✅ 状态标志变为`W`（Warm）
- ✅ 风扇保持50%速度（未达到60°C）

---

#### **测试2：60°C阈值**

**测试步骤**：
1. 将NTC1继续加热至60°C以上
2. 观察串口输出和风扇转速

**预期输出**：
```
NTC1: OVERHEAT! 60C reached
Fan speed: 50% -> 95%
[30s]   60.5     24.3     24.6     95%  !--
```

**验收标准**：
- ✅ 温度达到60°C时，打印过热信息
- ✅ 状态标志变为`!`（Overheat）
- ✅ **风扇自动切换至95%高速**
- ✅ 可用耳朵听到风扇转速明显增加

---

#### **测试3：温度回差**

**测试步骤**：
1. 停止加热，让NTC1自然降温
2. 观察状态切换

**预期行为**：

| 温度 | 状态变化 | 风扇速度 |
|------|----------|----------|
| 60°C → 58°C | `!` → `W` | 95% → 50% |
| 35°C → 33°C | `W` → `-` | 50% → 50% |

**验收标准**：
- ✅ 温度降到58°C时，从OVERHEAT恢复到WARM
- ✅ 风扇从95%降至50%
- ✅ 温度降到33°C时，从WARM恢复到NORMAL
- ✅ 2°C回差机制工作正常（防止频繁切换）

---

### 3.7 PWM波形验证（可选）

⚠️ **需要示波器**

**测试步骤**：
1. 将示波器探头连接至PA6（TIM3_CH1）
2. 测量PWM波形参数

**预期参数**：

| 参数 | 正常速度 | 高速 |
|------|----------|------|
| 频率 | 20kHz | 20kHz |
| 占空比 | 50% | 95% |
| 电压 | 0V~3.3V | 0V~3.3V |

**验收标准**：
- ✅ PWM频率准确（20kHz）
- ✅ 占空比准确（50% / 95%）
- ✅ 波形无毛刺

---

## 四、常见问题

### 4.1 温度显示异常

**问题描述**：温度显示为0.0°C或异常值

**可能原因**：
1. NTC传感器未连接
2. ADC+DMA未启动
3. 滤波器未就绪

**解决方法**：
1. 检查NTC传感器连接（PA0、PA1、PA2）
2. 检查ADC初始化是否成功
3. 等待8秒以上（滤波器就绪）

---

### 4.2 风扇不转

**问题描述**：风扇始终不转或转速异常

**可能原因**：
1. 风扇未连接至PA6
2. TIM3 PWM未启动
3. 风扇供电不足

**解决方法**：
1. 检查风扇连接（TIM3_CH1/PA6）
2. 用示波器验证PWM输出
3. 检查风扇供电电压（12V/5V）

---

### 4.3 风扇速度不切换

**问题描述**：温度超过60°C后，风扇仍保持50%

**可能原因**：
1. 温度阈值判断逻辑错误
2. 风扇控制函数未调用

**解决方法**：
1. 检查`update_overheat_flags()`函数
2. 检查`update_fan_control()`函数
3. 打印`overheat_flag`数组查看状态

---

### 4.4 温度跳变剧烈

**问题描述**：温度值跳变±5°C以上

**可能原因**：
1. 滤波器未启用
2. ADC采样不稳定
3. NTC传感器接触不良

**解决方法**：
1. 等待8秒以上（滤波器就绪）
2. 增加ADC采样时间（55.5 → 239.5 Cycles）
3. 检查NTC传感器接线

---

## 五、测试总结模板

```
阶段4测试报告
测试人员：________
测试时间：________

测试项目：
☐ 初始化测试      [  通过  /  失败  ]
☐ 温度采集测试    [  通过  /  失败  ]
☐ 滤波器测试      [  通过  /  失败  ]
☐ 状态打印测试    [  通过  /  失败  ]
☐ 心跳测试        [  通过  /  失败  ]
☐ 35°C阈值测试    [  通过  /  失败  /  跳过  ]
☐ 60°C阈值测试    [  通过  /  失败  /  跳过  ]
☐ 温度回差测试    [  通过  /  失败  /  跳过  ]
☐ PWM波形测试     [  通过  /  失败  /  跳过  ]

测试结论：[  全部通过  /  部分失败  ]

备注：
______________________________________
______________________________________
```

---

## 六、下一步计划

阶段4完成后，进入**阶段5：驱动层 - OLED显示驱动**

---

**文档版本**：v1.0  
**最后更新**：2026-02-12
