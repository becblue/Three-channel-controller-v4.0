# 阶段8：安全监控系统测试指?

---

## 📋 测试概述

**测试目标?** 验证15种异常类型的实时检测、真值表逻辑判断和智能异常解除机?

**测试时间?** ?30-40分钟

**测试工具?**
- 串口调试助手（波特率115200?
- 杜邦?/跳线?
- 万用?/示波器（可选）

---

## 🔌 硬件连接说明

### 必需连接

| 信号 | 引脚 | 连接说明 |
|-----|------|---------|
| **K1_EN** | PB9 | 通过跳线连接到GND?3.3V（模拟使能信号） |
| **K2_EN** | PB8 | 通过跳线连接到GND?3.3V（模拟使能信号） |
| **K3_EN** | PA15 | 通过跳线连接到GND?3.3V（模拟使能信号） |
| **DC_CTRL** | PB5 | 通过跳线连接?3.3V（模拟电源监控信号） |

### 状态反馈信号（测试B~J类异常时使用?

| 信号 | 引脚 | 默认状? | 测试用? |
|-----|------|---------|---------|
| **K1_1_STA** | PC4 | 低电平（内部下拉? | 模拟继电?1-1状? |
| **K1_2_STA** | PB1 | 低电平（内部下拉? | 模拟继电?1-2状? |
| **K2_1_STA** | PC5 | 低电平（内部下拉? | 模拟继电?2-1状? |
| **K2_2_STA** | PB10 | 低电平（内部下拉? | 模拟继电?2-2状? |
| **K3_1_STA** | PB0 | 低电平（内部下拉? | 模拟继电?3-1状? |
| **K3_2_STA** | PB11 | 低电平（内部下拉? | 模拟继电?3-2状? |
| **SW1_STA** | PA8 | 低电平（内部下拉? | 模拟接触?1状? |
| **SW2_STA** | PC9 | 低电平（内部下拉? | 模拟接触?2状? |
| **SW3_STA** | PC8 | 低电平（内部下拉? | 模拟接触?3状? |

### 报警输出信号（观察用?

| 信号 | 引脚 | 说明 |
|-----|------|------|
| **ALARM** | PB4 | 任何异常时输出低电平，可用LED观察 |
| **BEEP** | PB3 | 分级蜂鸣器输出，可用示波器观? |

---

## 🧪 测试步骤

### 测试前准?

1. **上电前连?**?
   - K1_EN、K2_EN、K3_EN?3.3V（上拉状态，表示全关闭）
   - DC_CTRL?3.3V（电源正常）
   - 其他状态反馈引脚保持默认下拉状?

2. **上电并打开串口调试助手**?
   - 波特率：115200
   - 数据位：8
   - 停止位：1
   - 校验位：?

3. **观察启动信息**?
```
========== Phase 8: Safety Monitor Test ==========
Testing safety monitoring system...

[Monitoring Status]
  - 15 error types real-time detection
  - Truth table logic validation
  - Intelligent error clearing mechanism
  - DC_CTRL power supply monitoring

[Instructions]
  K1_EN (PB9):  LOW=Open CH1,  HIGH=Close CH1
  K2_EN (PB8):  LOW=Open CH2,  HIGH=Close CH2
  K3_EN (PA15): LOW=Open CH3,  HIGH=Close CH3

[Status Monitor Started]

[Safety] Safety monitor initialized
```

---

### 测试1：A类异? - 使能信号冲突检?

#### 操作步骤
1. 保持K1_EN、K2_EN、K3_EN初始状态（全部3.3V?
2. 同时将K1_EN和K2_EN拉低到GND（模拟冲突）

#### 预期现象
**串口输出?**
```
[Safety] Error detected: A-Enable Conflict
[Alarm] Error set: A-Enable Conflict
```

**硬件现象?**
- ALARM引脚输出低电?
- BEEP引脚输出1秒间隔脉?

#### 恢复操作
将K1_EN或K2_EN其中一个恢复到3.3V（保留≤1路低电平?

#### 预期恢复现象
```
[Safety] Error cleared: A-Enable Conflict
[Alarm] Error cleared: A-Enable Conflict
```

---

### 测试2：B~G类异? - 继电器状态反馈异?

#### 操作步骤
1. 将K1_EN拉低到GND（触发打开通道1?
2. 等待继电器动作完成（?600ms?
3. 观察串口输出

#### 预期现象（如果继电器状态不符合真值表?
**串口输出?**
```
[ISR] K1_EN interrupt triggered, opening CH1...
[Relay] Opening CH1...
[Safety] Error detected: B-K1_1_STA Error
[Safety] Error detected: E-K1_2_STA Error
[Safety] Error detected: H-SW1_STA Error
```

**说明?**
- 如果实际硬件未连接继电器，K1_1_STA/K1_2_STA会保持低电平
- 真值表期望K1_1_STA/K1_2_STA为高电平，因此触发B和E类异?
- 同样SW1_STA也会触发H类异?

#### 手动模拟状态恢复（验证异常解除?
1. 使用杜邦线将K1_1_STA（PC4）连接到3.3V
2. 使用杜邦线将K1_2_STA（PB1）连接到3.3V
3. 使用杜邦线将SW1_STA（PA8）连接到3.3V

#### 预期恢复现象
```
[Safety] Error cleared: B-K1_1_STA Error
[Safety] Error cleared: E-K1_2_STA Error
[Safety] Error cleared: H-SW1_STA Error
```

---

### 测试3：K~M类异? - 温度异常检?

#### 操作步骤
1. 用热风枪或电烙铁加热NTC1传感器（PA0?
2. 观察串口输出的温度?
3. 当温度升至≥60℃时观察异常触发

#### 预期现象（温度≥60℃）
**串口输出?**
```
[Temp] NTC1: 62.5°C  NTC2: 25.3°C  NTC3: 24.8°C
[Temp] Fan speed changed: 50% -> 95%
[Safety] Error detected: K-NTC_1 Temperature Error
[Alarm] Error set: K-NTC_1 Temperature Error
```

**硬件现象?**
- ALARM引脚输出低电?
- BEEP引脚输出持续低电平（温度异常最高优先级?
- 风扇PWM占空比提升到95%

#### 恢复操作
移除热源，等待温度自然降温至?58?

#### 预期恢复现象
```
[Temp] NTC1: 57.2°C  NTC2: 25.1°C  NTC3: 24.9°C
[Temp] Fan speed changed: 95% -> 50%
[Safety] Error cleared: K-NTC_1 Temperature Error
[Alarm] Error cleared: K-NTC_1 Temperature Error
```

---

### 测试4：O类异? - 外部电源监控

#### 操作步骤
1. 将DC_CTRL（PB5）从3.3V断开（或连接到GND?
2. 观察中断触发

#### 预期现象
**串口输出?**
```
[Safety] Error detected: O-Power Supply Error
[Alarm] Error set: O-Power Supply Error
```

**硬件现象?**
- ALARM引脚输出低电?
- BEEP引脚输出1秒间隔脉?

#### 恢复操作
将DC_CTRL（PB5）重新连接到3.3V

#### 预期恢复现象
```
[Safety] Error cleared: O-Power Supply Error
[Alarm] Error cleared: O-Power Supply Error
```

---

### 测试5：多异常同时存在 - 优先级测?

#### 操作步骤
1. 同时触发A类异常（K1_EN和K2_EN拉低?
2. 加热NTC1触发K类异常（温度?60℃）
3. 观察报警优先?

#### 预期现象
**串口输出?**
```
[Safety] Error detected: A-Enable Conflict
[Safety] Error detected: K-NTC_1 Temperature Error
[Alarm] Error set: A-Enable Conflict
[Alarm] Error set: K-NTC_1 Temperature Error
```

**硬件现象（优先级验证）：**
- ALARM引脚：持续低电平
- BEEP引脚?**持续低电?**（K类异常优先级最高，覆盖A类的1秒脉冲）

#### 说明
蜂鸣器优先级规则?
- **K~M类（温度异常?** > B~J类（状态反馈异常） > A、N、O类（冲突/自检/电源异常?
- 多个异常同时存在时，选择最高优先级的报警模?

---

### 测试6：异常解除条? - 真值表验证

#### 操作步骤
1. 触发通道1打开（K1_EN拉低?
2. 手动模拟状态反馈错误（K1_1_STA保持低电平）
3. 观察B类异常触?
4. 手动拉高K1_1_STA（PC4）到3.3V
5. 同时确保K1_2_STA和SW1_STA也拉?
6. 观察异常解除

#### 预期现象
**触发异常时：**
```
[Safety] Error detected: B-K1_1_STA Error
```

**符合真值表后自动解除：**
```
[Safety] Error cleared: B-K1_1_STA Error
```

---

## 📊 真值表参?

### Channel 1 打开状?

| 信号 | 期望? | 实际检? |
|-----|-------|---------|
| K1_EN | 0（LOW? | 通过 HAL_GPIO_ReadPin(K1_EN_GPIO_Port, K1_EN_Pin) |
| K2_EN | 1（HIGH? | 通过 HAL_GPIO_ReadPin(K2_EN_GPIO_Port, K2_EN_Pin) |
| K3_EN | 1（HIGH? | 通过 HAL_GPIO_ReadPin(K3_EN_GPIO_Port, K3_EN_Pin) |
| K1_1_STA | 1（HIGH? | 通过 HAL_GPIO_ReadPin(K1_1_STA_GPIO_Port, K1_1_STA_Pin) |
| K1_2_STA | 1（HIGH? | 通过 HAL_GPIO_ReadPin(K1_2_STA_GPIO_Port, K1_2_STA_Pin) |
| K2_1_STA | 0（LOW? | 通过 HAL_GPIO_ReadPin(K2_1_STA_GPIO_Port, K2_1_STA_Pin) |
| K2_2_STA | 0（LOW? | 通过 HAL_GPIO_ReadPin(K2_2_STA_GPIO_Port, K2_2_STA_Pin) |
| K3_1_STA | 0（LOW? | 通过 HAL_GPIO_ReadPin(K3_1_STA_GPIO_Port, K3_1_STA_Pin) |
| K3_2_STA | 0（LOW? | 通过 HAL_GPIO_ReadPin(K3_2_STA_GPIO_Port, K3_2_STA_Pin) |
| SW1_STA | 1（HIGH? | 通过 HAL_GPIO_ReadPin(SW1_STA_GPIO_Port, SW1_STA_Pin) |
| SW2_STA | 0（LOW? | 通过 HAL_GPIO_ReadPin(SW2_STA_GPIO_Port, SW2_STA_Pin) |
| SW3_STA | 0（LOW? | 通过 HAL_GPIO_ReadPin(SW3_STA_GPIO_Port, SW3_STA_Pin) |

### Channel 2 打开状?

| 信号 | 期望? |
|-----|-------|
| K1_EN | 1（HIGH? |
| K2_EN | 0（LOW? |
| K3_EN | 1（HIGH? |
| K1_1_STA | 0（LOW? |
| K1_2_STA | 0（LOW? |
| K2_1_STA | 1（HIGH? |
| K2_2_STA | 1（HIGH? |
| K3_1_STA | 0（LOW? |
| K3_2_STA | 0（LOW? |
| SW1_STA | 0（LOW? |
| SW2_STA | 1（HIGH? |
| SW3_STA | 0（LOW? |

### Channel 3 打开状?

| 信号 | 期望? |
|-----|-------|
| K1_EN | 1（HIGH? |
| K2_EN | 1（HIGH? |
| K3_EN | 0（LOW? |
| K1_1_STA | 0（LOW? |
| K1_2_STA | 0（LOW? |
| K2_1_STA | 0（LOW? |
| K2_2_STA | 0（LOW? |
| K3_1_STA | 1（HIGH? |
| K3_2_STA | 1（HIGH? |
| SW1_STA | 0（LOW? |
| SW2_STA | 0（LOW? |
| SW3_STA | 1（HIGH? |

### 全部关闭状?

| 信号 | 期望? |
|-----|-------|
| K1_EN | 1（HIGH? |
| K2_EN | 1（HIGH? |
| K3_EN | 1（HIGH? |
| 所有STA信号 | 0（LOW? |

---

## 🧪 详细测试流程

### 测试A类：使能信号冲突

#### 步骤1：初始状态检?
- K1_EN=3.3V, K2_EN=3.3V, K3_EN=3.3V
- 串口应输出：无异?

#### 步骤2：触发双路冲?
- 将K1_EN和K2_EN同时拉低到GND
- 等待100ms（安全监控周期）

#### 步骤3：观察输?
```
[Safety] Error detected: A-Enable Conflict
[Alarm] Error set: A-Enable Conflict
```

#### 步骤4：解除异?
- 将K1_EN恢复?3.3V（保留K2_EN=GND?
- 等待100ms

#### 步骤5：观察恢?
```
[Safety] Error cleared: A-Enable Conflict
[Alarm] Error cleared: A-Enable Conflict
```

#### 步骤6：触发三路冲突（更严重）
- 将K1_EN、K2_EN、K3_EN全部拉低到GND
- 观察：应立即检测到A类异?

#### 步骤7：全部恢?
- 将K1_EN、K2_EN、K3_EN全部恢复?3.3V
- 观察：A类异常应自动解除

---

### 测试B~J类：状态反馈异?

#### 子测?1：B类异常（K1_1_STA状态异常）

**步骤1?** 触发通道1打开
- 将K1_EN拉低到GND
- 等待600ms（继电器动作时间?

**步骤2?** 观察输出
```
[ISR] K1_EN interrupt triggered, opening CH1...
[Relay] Opening CH1...
```

**步骤3?** 检查状态反馈异?
- 由于K1_1_STA实际为低电平（内部下拉），但真值表期望高电?
- 系统应检测到B类异?

```
[Safety] Error detected: B-K1_1_STA Error
[Alarm] Error set: B-K1_1_STA Error
```

**步骤4?** 手动模拟正确状?
- 用杜邦线将K1_1_STA（PC4）连接到3.3V
- 用杜邦线将K1_2_STA（PB1）连接到3.3V
- 用杜邦线将SW1_STA（PA8）连接到3.3V
- 等待100ms

**步骤5?** 观察异常解除
```
[Safety] Error cleared: B-K1_1_STA Error
[Safety] Error cleared: E-K1_2_STA Error
[Safety] Error cleared: H-SW1_STA Error
```

#### 子测?2：其他B~J类异?
重复上述步骤，测试其他通道和其他状态反馈引?

---

### 测试K~M类：温度异常

#### 步骤1：观察初始温?
```
[Temp] NTC1: 25.3°C  NTC2: 24.8°C  NTC3: 25.1°C
[Temp] Fan speed: 50%
```

#### 步骤2：加热NTC1（模拟过温）
- 使用热风枪或电烙铁加热NTC1传感器（PA0附近?
- 观察温度上升

#### 步骤3：温度达?60?
```
[Temp] NTC1: 60.5°C  NTC2: 24.8°C  NTC3: 25.1°C
[Temp] Fan speed changed: 50% -> 95%
[Safety] Error detected: K-NTC_1 Temperature Error
[Alarm] Error set: K-NTC_1 Temperature Error
```

#### 步骤4：观察蜂鸣器优先?
- BEEP引脚应输?**持续低电?**（温度异常最高优先级?

#### 步骤5：等待降?
- 移除热源
- 等待温度降至?58℃（考虑2℃回差）

#### 步骤6：观察异常解?
```
[Temp] NTC1: 57.8°C  NTC2: 24.9°C  NTC3: 25.0°C
[Temp] Fan speed changed: 95% -> 50%
[Safety] Error cleared: K-NTC_1 Temperature Error
[Alarm] Error cleared: K-NTC_1 Temperature Error
```

---

### 测试O类：外部电源监控

#### 步骤1：初始状?
- DC_CTRL（PB5）连接到3.3V
- 系统应无O类异?

#### 步骤2：模拟电源异?
- 将DC_CTRL断开或连接到GND
- 等待中断触发

#### 步骤3：观察输?
```
[Safety] Error detected: O-Power Supply Error
[Alarm] Error set: O-Power Supply Error
```

**硬件现象?**
- ALARM引脚输出低电?
- BEEP引脚输出1秒间隔脉?

#### 步骤4：恢复电?
- 将DC_CTRL重新连接?3.3V

#### 步骤5：观察恢?
```
[Safety] Error cleared: O-Power Supply Error
[Alarm] Error cleared: O-Power Supply Error
```

---

### 测试N类：自检异常（接口测试）

**说明?** N类异常由self_test模块触发，阶?8只验证接?

#### 步骤1：在串口手动调用测试命令
```c
// 在main.c的while循环中临时添加测试代?
Safety_SetSelfTestError();  // 设置N类异?
```

#### 步骤2：观察输?
```
[Safety] Self-test error set (N)
[Safety] Error detected: N-Self Test Error
[Alarm] Error set: N-Self Test Error
```

#### 步骤3：测试解?
```c
Safety_ClearSelfTestError();  // 清除N类异?
```

#### 步骤4：观察输?
```
[Safety] Self-test error cleared (N)
[Safety] Error cleared: N-Self Test Error
[Alarm] Error cleared: N-Self Test Error
```

---

## 🔍 故障排除

### 问题1：异常未被检测到

**可能原因?**
- Safety_Update()未被调用或调用频率不?
- 检测周期设置过长（>100ms?

**解决方法?**
- 确认main.c的while循环中有 `Safety_Update()`
- 确认HAL_Delay(100)设置正确

---

### 问题2：异常无法解?

**可能原因?**
- 状态未完全恢复到真值表期望?
- Safety_TryClearErrors()逻辑有误

**解决方法?**
- 使用 `Safety_PrintStatus()` 查看当前异常位图
- 检查所有相关引脚状态是否符合真值表
- 检查温度回差条件（58℃）

---

### 问题3：DC_CTRL中断未触?

**可能原因?**
- CubeMX中DC_CTRL未配置为中断模式
- NVIC中断优先级未设置

**解决方法?**
- 检查gpio.c中DC_CTRL的配置：`GPIO_MODE_IT_RISING_FALLING`
- 检查中断是否使能：`HAL_NVIC_EnableIRQ(EXTI9_5_IRQn)`

---

### 问题4：报警输出异?

**可能原因?**
- alarm_output模块未正确集?
- 异常位图传递错?

**解决方法?**
- 确认Safety_Update()中调用了Alarm_SetError()
- 使用Alarm_PrintStatus()检查报警模块状?

---

## 📈 测试记录?

| 测试? | 测试结果 | 备注 |
|-------|---------|------|
| A类异常检? | ? PASS / ? FAIL |  |
| A类异常解? | ? PASS / ? FAIL |  |
| B~G类异常检? | ? PASS / ? FAIL |  |
| B~G类异常解? | ? PASS / ? FAIL |  |
| H~J类异常检? | ? PASS / ? FAIL |  |
| H~J类异常解? | ? PASS / ? FAIL |  |
| K~M类异常检? | ? PASS / ? FAIL |  |
| K~M类异常解? | ? PASS / ? FAIL |  |
| N类异常接? | ? PASS / ? FAIL |  |
| O类异常检? | ? PASS / ? FAIL |  |
| O类异常解? | ? PASS / ? FAIL |  |
| 多异常优先级 | ? PASS / ? FAIL |  |
| 真值表逻辑验证 | ? PASS / ? FAIL |  |
| ALARM引脚输出 | ? PASS / ? FAIL |  |
| BEEP分级输出 | ? PASS / ? FAIL |  |

---

## 🎯 验收标准

### 必须满足的条?

- ? 所?15种异常类型能够正确检?
- ? 异常触发时ALARM引脚立即输出低电?
- ? 蜂鸣器按照异常类型正确分级（持续/50ms/1s?
- ? 多异常并存时优先级正确（K>B>A?
- ? 异常解除条件符合真值表逻辑
- ? DC_CTRL中断响应正常
- ? 温度异常回差机制有效?2℃）
- ? 与继电器控制模块协同工作正常

### 性能指标

- **响应时间**：异常发生到报警输出 < 200ms
- **CPU占用**?< 3%
- **内存占用**?< 200字节
- **误报?**?0%（无误触发）

---

## 📝 测试注意事项

1. **测试顺序**：建议按照A→B~J→K~M→O→N的顺序进行，从简单到复杂
2. **状态恢?**：每次测试后确保所有信号恢复到初始状?
3. **温度测试**：K~M类测试需要耐心等待加热和降温过?
4. **硬件保护**：使用杜邦线操作时注意防止短?
5. **记录输出**：建议录屏或保存串口日志用于分析

---

## 🔧 调试命令参?

### 查看当前状?
```c
Safety_PrintStatus();     // 打印安全监控状?
Relay_PrintStatus();      // 打印继电器状?
Temperature_PrintStatus(); // 打印温度状?
Alarm_PrintStatus();      // 打印报警状?
```

### 手动触发/清除异常（调试用?
```c
// 在main.c中临时添?
Safety_SetSelfTestError();    // 触发N类异?
Safety_ClearSelfTestError();  // 清除N类异?
```

---

## ? 测试完成标志

当以下所有项均通过后，阶段8测试完成?

- [x] 15种异常类型全部测试通过
- [x] 真值表逻辑验证正确
- [x] 异常解除机制工作正常
- [x] 多异常优先级正确
- [x] DC_CTRL中断响应正常
- [x] 与其他模块集成无冲突
- [x] 编译无错误无警告
- [x] 连续运行30分钟稳定

**完成后可进入阶段9：系统自检模块开?**

---

**文档创建时间?** 2026-02-13  
**文档版本?** v1.0  
**作者：** Three-channel Controller Team
