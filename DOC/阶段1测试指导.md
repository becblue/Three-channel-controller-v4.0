# 阶段1：基础层 - 通用定义模块 - 测试指导

## 测试目标

验证通用定义模块（common_def.h/c）的正确性，包括枚举定义、常量定义和宏定义功能。

---

## 已完成的开发

### ✅ 新增文件

1. **`Core/Inc/common_def.h`** - 通用定义头文件
   - 异常类型枚举（15种异常A~O）
   - 通道枚举（CHANNEL_1/2/3/NONE）
   - 继电器状态枚举（OFF/ON）
   - 蜂鸣器模式枚举（4种模式）
   - 系统状态枚举
   - 全局常量定义（温度阈值、时间常量等）
   - 调试宏定义（DEBUG_PRINTF、LOG_INFO等）

2. **`Core/Src/common_def.c`** - 通用定义实现文件
   - 获取异常类型字符串
   - 获取通道名称字符串
   - 获取系统状态字符串
   - 模块初始化
   - 打印系统配置信息

---

## 测试步骤

### 步骤1：修改main.c文件

#### 1.1 添加头文件包含

在main.c的`/* USER CODE BEGIN Includes */`区域添加：

```c
/* USER CODE BEGIN Includes */
#include "common_def.h"
/* USER CODE END Includes */
```

#### 1.2 修改`USER CODE BEGIN 2`区域

将原来的测试代码替换为：

```c
  /* USER CODE BEGIN 2 */
  
  // Phase 1 Test: Common Definition Module
  DEBUG_PRINTF("\r\n========== Phase 1 Test ==========\r\n");
  DEBUG_PRINTF("Common Definition Module Test\r\n");
  DEBUG_PRINTF("==================================\r\n\r\n");
  
  // Initialize common definition module
  CommonDef_Init();
  
  // Print system configuration
  CommonDef_PrintConfig();
  
  // Test enum definitions
  Channel_e ch = CHANNEL_1;
  DEBUG_PRINTF("Channel enum test: %s\r\n", CommonDef_GetChannelString(ch));
  
  ErrorType_e err = ERROR_TYPE_A;
  DEBUG_PRINTF("Error type test: %s\r\n", CommonDef_GetErrorString(err));
  
  SystemState_e state = SYSTEM_STATE_RUNNING;
  DEBUG_PRINTF("System state test: %s\r\n\r\n", CommonDef_GetSystemStateString(state));
  
  DEBUG_PRINTF("========== Phase 1 Test PASS ==========\r\n\r\n");

  /* USER CODE END 2 */
```

#### 1.3 修改`USER CODE BEGIN 3`区域（主循环内）

将原来的测试代码替换为：

```c
    /* USER CODE BEGIN 3 */
    
    // Phase 1 Test: Heartbeat every 5 seconds
    DEBUG_PRINTF("[%lu ms] System Running - Phase 1 Test OK\r\n", HAL_GetTick());
    HAL_Delay(5000);
  }
  /* USER CODE END 3 */
```

---

### 步骤2：编译工程

1. 打开Keil MDK-ARM
2. 打开工程文件：`MDK-ARM/Three-channel controller_v4.0.uvprojx`
3. 编译工程（F7）

**预期结果**：
- 编译通过，0 Error，0 Warning
- 新增的common_def.c文件被正确编译

---

### 步骤3：下载并测试

1. 连接ST-Link和串口
2. 下载程序（F8）
3. 打开串口调试助手（115200波特率）
4. 复位开发板

---

## 预期输出

串口应输出以下内容：

```
========== Phase 1 Test ==========
Common Definition Module Test
==================================

[INFO] CommonDef module initializing...
[INFO] CommonDef module initialized successfully

========================================
    三通道切换箱控制系统 v4.0
========================================

【系统配置信息】
MCU型号: STM32F103RCT6
系统主频: 72MHz
外部晶振: 8MHz HSE

【温度控制参数】
正常温度阈值: 35.0°C
过温告警阈值: 60.0°C
温度回差: 2.0°C
正常风扇PWM: 50%
高温风扇PWM: 95%

【时间参数】
LOGO显示时间: 2000ms
系统自检时间: 3000ms
继电器脉冲时长: 500ms
防抖检测间隔: 50ms
防抖检测次数: 3次

【异常类型定义】
A - 使能冲突异常
B~G - 继电器状态反馈异常
H~J - 接触器状态反馈异常
K~M - 温度异常
N - 自检异常
O - 电源监控异常

【性能指标】
系统响应时间要求: <500ms

========================================
Configuration loaded successfully!
========================================

Channel enum test: 通道1
Error type test: A-使能冲突
System state test: 正常运行

========== Phase 1 Test PASS ==========

[xxxx ms] System Running - Phase 1 Test OK
[xxxx ms] System Running - Phase 1 Test OK
[xxxx ms] System Running - Phase 1 Test OK
...（每5秒输出一次）
```

---

## 验收标准

### 编译验收

- ✅ 编译通过，0 Error，0 Warning
- ✅ common_def.c和common_def.h文件被正确包含和编译

### 功能验收

1. **枚举测试** ✅
   - Channel_e枚举定义正确
   - ErrorType_e枚举定义正确（15种异常）
   - SystemState_e枚举定义正确
   - 枚举字符串转换函数工作正常

2. **常量测试** ✅
   - 温度阈值常量定义正确（35℃、60℃）
   - 风扇PWM常量定义正确（50%、95%）
   - 时间常量定义正确（2s、3s、500ms等）

3. **宏测试** ✅
   - DEBUG_PRINTF宏工作正常
   - LOG_INFO宏工作正常
   - LOG_WARNING宏工作正常
   - LOG_ERROR宏工作正常

4. **系统配置** ✅
   - CommonDef_Init()初始化成功
   - CommonDef_PrintConfig()能正确打印所有配置信息

5. **串口输出** ✅
   - 所有信息能正确输出到串口
   - 中文显示正常（如果支持）
   - 格式化输出正确（%.1f、%d、%lu等）

---

## 功能点检查清单

| 序号 | 检查项目 | 说明 | 状态 |
|------|---------|------|------|
| 1 | 异常类型枚举 | 15种异常A~O定义完整 | ⏳ 待测 |
| 2 | 通道枚举 | CHANNEL_1/2/3/NONE定义 | ⏳ 待测 |
| 3 | 继电器状态枚举 | OFF/ON定义 | ⏳ 待测 |
| 4 | 蜂鸣器模式枚举 | 4种模式定义 | ⏳ 待测 |
| 5 | 系统状态枚举 | 5种状态定义 | ⏳ 待测 |
| 6 | 温度常量 | 35℃、60℃、2℃回差 | ⏳ 待测 |
| 7 | 风扇PWM常量 | 50%、95% | ⏳ 待测 |
| 8 | 时间常量 | 2s、3s、500ms、50ms等 | ⏳ 待测 |
| 9 | DEBUG宏 | 打印功能正常 | ⏳ 待测 |
| 10 | LOG宏 | INFO/WARNING/ERROR | ⏳ 待测 |
| 11 | 位操作宏 | SET/CLEAR/READ/TOGGLE | ⏳ 待测 |
| 12 | 枚举字符串函数 | 正确返回描述 | ⏳ 待测 |
| 13 | 模块初始化 | Init()函数正常 | ⏳ 待测 |
| 14 | 配置打印 | PrintConfig()完整 | ⏳ 待测 |

---

## 常见问题排查

### 问题1：编译错误 - 找不到common_def.h

**原因**：
- 文件未添加到工程
- 头文件路径未配置

**解决方法**：
1. 确认`Core/Inc/common_def.h`和`Core/Src/common_def.c`文件存在
2. 在Keil工程中查看文件是否被包含
3. 检查include路径配置

### 问题2：枚举值显示错误

**原因**：
- 枚举定义顺序错误
- 枚举值计算错误

**解决方法**：
1. 检查common_def.h中枚举定义
2. 确认位操作值正确（0x0001、0x0002、0x0004...）

### 问题3：中文显示乱码

**原因**：
- 串口助手编码设置错误
- 源文件编码不是UTF-8

**解决方法**：
1. 设置串口助手为UTF-8编码
2. 确认源文件保存为UTF-8编码
3. 如果仍有问题，可使用英文输出

---

## 测试完成标志

当以下所有验收标准都满足时，阶段1测试通过：

- ✅ 工程编译无错误无警告
- ✅ 枚举定义测试通过
- ✅ 常量定义测试通过
- ✅ 宏定义测试通过
- ✅ 系统配置打印完整
- ✅ 串口输出格式正确

---

## 下一步

阶段1测试通过后，将进入：

**阶段2：驱动层 - 调试串口增强**

---

**测试日期**：________

**测试人员**：________

**测试结果**：[ ] 通过  [ ] 未通过

**备注**：
