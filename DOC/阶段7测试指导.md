# 阶段7测试指导 - 继电器控制模块

## 测试目标
验证三通道继电器控制模块的功能是否正常，包括：
- ✅ 继电器控制脉冲正确（500ms）
- ✅ 互锁机制工作正常（不能同时打开多通道）
- ✅ 状态反馈检测正确
- ✅ 防抖机制有效
- ✅ K1/K2/K3_EN中断响应正常

---

## 硬件连接说明

### 1. 继电器控制引脚（输出）

**⚡ 重要：磁保持继电器控制逻辑**
- **静态状态**：所有控制引脚保持**高电平**
- **触发动作**：输出**500ms低电平脉冲**
- **脉冲结束**：恢复**高电平**，继电器状态被磁保持

#### 通道1（CH1）
| 功能 | 引脚 | 说明 |
|------|------|------|
| K1_1_ON  | PC0  | 继电器1 ON控制（低脉冲有效，静态高电平） |
| K1_1_OFF | PC1  | 继电器1 OFF控制（低脉冲有效，静态高电平） |
| K1_2_ON  | **PA12** | 继电器2 ON控制（低脉冲有效，静态高电平）**⚠️ 注意：实际为PA12，非PB12** |
| K1_2_OFF | PA3  | 继电器2 OFF控制（低脉冲有效，静态高电平） |

#### 通道2（CH2）
| 功能 | 引脚 | 说明 |
|------|------|------|
| K2_1_ON  | PC2  | 继电器1 ON控制（低脉冲有效，静态高电平） |
| K2_1_OFF | PC3  | 继电器1 OFF控制（低脉冲有效，静态高电平） |
| K2_2_ON  | PA4  | 继电器2 ON控制（低脉冲有效，静态高电平） |
| K2_2_OFF | PA5  | 继电器2 OFF控制（低脉冲有效，静态高电平） |

#### 通道3（CH3）
| 功能 | 引脚 | 说明 |
|------|------|------|
| K3_1_ON  | PC7  | 继电器1 ON控制（低脉冲有效，静态高电平） |
| K3_1_OFF | PC6  | 继电器1 OFF控制（低脉冲有效，静态高电平） |
| K3_2_ON  | PD2  | 继电器2 ON控制（低脉冲有效，静态高电平） |
| K3_2_OFF | PA7  | 继电器2 OFF控制（低脉冲有效，静态高电平） |

### 2. 状态反馈引脚（输入）

#### 继电器状态反馈（6路）
| 功能 | 引脚 | 说明 |
|------|------|------|
| K1_1_STA | PC4  | 通道1继电器1状态（高=ON，低=OFF） |
| K1_2_STA | PB1  | 通道1继电器2状态（高=ON，低=OFF） |
| K2_1_STA | PC5  | 通道2继电器1状态（高=ON，低=OFF） |
| K2_2_STA | PB10 | 通道2继电器2状态（高=ON，低=OFF） |
| K3_1_STA | PB0  | 通道3继电器1状态（高=ON，低=OFF） |
| K3_2_STA | PB11 | 通道3继电器2状态（高=ON，低=OFF） |

#### 接触器状态反馈（3路）
| 功能 | 引脚 | 说明 |
|------|------|------|
| SW1_STA | PA8  | 通道1接触器状态（高=ON，低=OFF） |
| SW2_STA | PC9  | 通道2接触器状态（高=ON，低=OFF） |
| SW3_STA | PC8  | 通道3接触器状态（高=ON，低=OFF） |

### 3. 使能控制引脚（外部中断输入）

| 功能 | 引脚 | 说明 |
|------|------|------|
| K1_EN | PB9  | 通道1使能（低=打开，高=关闭） |
| K2_EN | PB8  | 通道2使能（低=打开，高=关闭） |
| K3_EN | PA15 | 通道3使能（低=打开，高=关闭） |

### 4. 连接要求

**最低测试要求**（软件功能测试）：
- 使用示波器或逻辑分析仪监测控制引脚输出波形
- 状态反馈引脚可暂时不接（测试时会显示ERROR状态）
- 使能引脚可用跳线手动接地/VCC测试中断

**完整功能测试**（硬件联调）：
- 连接实际继电器模块
- 连接状态反馈回路
- 连接接触器状态反馈
- 外部使能信号接入

---

## 测试步骤

### 测试逻辑设计

本测试采用**循环测试**方式，让三个通道轮流打开和关闭，便于观察每个继电器的物理动作。

**测试流程**：
1. 初始化所有通道（全部关闭）
2. 进入无限循环：
   - 打开通道1 → 保持2秒 → 关闭通道1 → 等待1秒
   - 打开通道2 → 保持2秒 → 关闭通道2 → 等待1秒
   - 打开通道3 → 保持2秒 → 关闭通道3 → 等待1秒
   - 循环重复...

**优点**：
- ✅ 可以持续观察每个继电器的物理动作（听到咔咔声）
- ✅ 示波器可以捕捉多次波形对比
- ✅ 便于检查状态反馈是否稳定
- ✅ 自动化测试，无需手动干预

---

### 循环周期说明

每个完整循环时间：**9秒**

| 时间段 | 动作 | 持续时间 |
|--------|------|----------|
| 0-0.5s | 通道1打开（500ms脉冲） | 0.5s |
| 0.5-2.5s | 通道1保持打开 | 2s |
| 2.5-3s | 通道1关闭（500ms脉冲） | 0.5s |
| 3-4s | 等待 | 1s |
| 4-4.5s | 通道2打开（500ms脉冲） | 0.5s |
| 4.5-6.5s | 通道2保持打开 | 2s |
| 6.5-7s | 通道2关闭（500ms脉冲） | 0.5s |
| 7-8s | 等待 | 1s |
| 8-8.5s | 通道3打开（500ms脉冲） | 0.5s |
| 8.5-10.5s | 通道3保持打开 | 2s |
| 10.5-11s | 通道3关闭（500ms脉冲） | 0.5s |
| 11-12s | 等待 | 1s |
| **循环重复** | - | - |

---

### 预期串口输出（每个循环）

```
========== Relay Cycle Test (Loop) ==========

[Cycle] Opening Channel 1...
[Relay] Opening CH1...
  -> CH1 relay activated, waiting 2s...
[Cycle] Closing Channel 1...
[Relay] Closing CH1...
  -> CH1 relay deactivated, waiting 1s...

[Cycle] Opening Channel 2...
[Relay] Opening CH2...
  -> CH2 relay activated, waiting 2s...
[Cycle] Closing Channel 2...
[Relay] Closing CH2...
  -> CH2 relay deactivated, waiting 1s...

[Cycle] Opening Channel 3...
[Relay] Opening CH3...
  -> CH3 relay activated, waiting 2s...
[Cycle] Closing Channel 3...
[Relay] Closing CH3...
  -> CH3 relay deactivated, waiting 1s...

--- Loop completed, restarting... ---

[Cycle] Opening Channel 1...
...
```

---

### 预期硬件现象

#### 通道1（K1.1、K1.2）
- **打开时**：听到2个继电器"咔"声，K1_1_ON (PC0) 和 K1_2_ON (PB12) 各输出500ms低脉冲
- **保持2秒**：继电器保持吸合状态（磁保持）
- **关闭时**：听到2个继电器"咔"声，K1_1_OFF (PC1) 和 K1_2_OFF (PA3) 各输出500ms低脉冲

#### 通道2（K2.1、K2.2）
- **打开时**：听到2个继电器"咔"声，K2_1_ON (PC2) 和 K2_2_ON (PA4) 各输出500ms低脉冲
- **保持2秒**：继电器保持吸合状态（磁保持）
- **关闭时**：听到2个继电器"咔"声，K2_1_OFF (PC3) 和 K2_2_OFF (PA5) 各输出500ms低脉冲

#### 通道3（K3.1、K3.2）
- **打开时**：听到2个继电器"咔"声，K3_1_ON (PC7) 和 K3_2_ON (PD2) 各输出500ms低脉冲
- **保持2秒**：继电器保持吸合状态（磁保持）
- **关闭时**：听到2个继电器"咔"声，K3_1_OFF (PC6) 和 K3_2_OFF (PA7) 各输出500ms低脉冲

---

### 示波器观察要点

#### 测量点建议
1. **通道1**：PC0 (K1_1_ON) 或 PC1 (K1_1_OFF)
2. **通道2**：PC2 (K2_1_ON) 或 PC3 (K2_1_OFF)
3. **通道3**：PC7 (K3_1_ON) 或 PC6 (K3_1_OFF)

#### 波形特征
- **静态状态**：高电平（约3.3V）
- **触发脉冲**：低电平（约0V），持续500ms
- **脉冲结束**：恢复高电平

**正常波形示例（ON引脚）**：
```
     3.3V ▬▬▬▬▬▬▬▐               ▐▬▬▬▬▬▬▬▬
                  └───────────────┘
       0V          ←── 500ms ──→
                    (低电平脉冲)
```

---

### 状态反馈检查

如果已连接状态反馈引脚（K1_1_STA ~ K3_2_STA），可以观察：
- ✅ 继电器打开后，对应STA引脚应为高电平
- ✅ 继电器关闭后，对应STA引脚应为低电平
- ✅ 如果反馈异常，串口会输出 "ERROR" 状态

---

### 测试操作步骤

#### 步骤1：上电初始化
1. 给开发板上电
2. 打开串口调试助手（波特率115200）
3. 观察初始化输出

**预期输出**：
```
[Relay] Module initialized
[Relay] All channels closed (interlock enabled)
[Relay] Pulse width: 500ms
[Relay] Debounce: 50ms x 3 times
```

#### 步骤2：观察循环测试
1. 程序自动进入循环测试
2. 每9秒完成一个循环（3个通道×3秒/通道）
3. 持续观察至少3个完整循环（约30秒）

#### 步骤3：物理检查
1. **听声音**：每次打开/关闭应听到2个继电器的"咔咔"声（每通道2路继电器）
2. **看指示灯**：如果继电器板有LED指示灯，观察ON/OFF状态
3. **测量输出**：如果连接了负载，用万用表测量输出端通断

#### 步骤4：示波器验证（可选）
1. 连接示波器到任一控制引脚（如PC0）
2. 触发模式设为下降沿
3. 观察500ms低电平脉冲波形

---

## 验收标准

### 基本功能验收

| 测试项 | 验收标准 | 检查方法 | 状态 |
|--------|----------|----------|------|
| 模块初始化 | 串口输出初始化信息，所有引脚为高电平 | 串口监控 + 万用表 | ⬜ |
| 循环测试启动 | 进入循环，每9秒一次 | 串口监控 + 计时 | ⬜ |
| 通道1控制 | K1.1、K1.2正确动作 | 听继电器声音 | ⬜ |
| 通道2控制 | K2.1、K2.2正确动作 | 听继电器声音 | ⬜ |
| 通道3控制 | K3.1、K3.2正确动作 | 听继电器声音 | ⬜ |
| 脉冲宽度 | 500ms低电平脉冲 | 示波器测量 | ⬜ |
| 静态电平 | 非触发时保持高电平 | 示波器 / 万用表 | ⬜ |
| 磁保持特性 | 脉冲结束后继电器保持状态 | 观察物理状态 | ⬜ |

### 高级功能验收（需要硬件连接）

| 测试项 | 验收标准 | 检查方法 | 状态 |
|--------|----------|----------|------|
| 状态反馈 | STA引脚反映继电器实际状态 | 串口监控 / 万用表 | ⬜ |
| 接触器反馈 | SW_STA引脚正确 | 串口监控 / 万用表 | ⬜ |
| 使能中断 | K1/K2/K3_EN触发正确 | 手动测试（见下文） | ⬜ |
| 互锁机制 | 不能同时打开多通道 | 手动测试（见下文） | ⬜ |

---

## 附加测试：手动功能测试

### 测试1：使能中断测试

**注意**：此测试需要暂停循环测试，或在循环间隙手动操作。

#### 操作步骤
1. 准备跳线或按键连接到K1_EN (PB9)
2. 将K1_EN接地（产生下降沿中断）
3. 观察串口输出和继电器动作
4. 将K1_EN恢复高电平（产生上升沿中断）
5. 观察通道是否关闭

#### 预期现象
- K1_EN拉低 → 通道1应打开（如果无其他通道激活）
- K1_EN恢复高 → 通道1应关闭
- 串口输出对应的打开/关闭消息

#### 测试其他通道
- K2_EN (PB8) → 控制通道2
- K3_EN (PA15) → 控制通道3

---

### 测试2：互锁机制验证

**目的**：验证三通道互锁，同一时间只能有一个通道激活。

#### 操作步骤
1. 修改代码，注释掉循环测试中的关闭操作，保持通道1打开
2. 重新编译下载
3. 通道1打开后，尝试通过K2_EN或K3_EN打开其他通道

#### 预期现象
- 通道1激活时，尝试打开通道2/3应被拒绝
- 串口输出：`[Relay] Interlock: CH1 is active, cannot open CH2/3`

#### 解锁测试
1. 先关闭通道1
2. 再尝试打开通道2/3
3. 应该可以成功打开

---

## 常见问题及排查

### 问题1：编译错误 - 未定义的引用

**现象**：
```
undefined reference to 'Relay_Init'
undefined reference to 'Relay_OpenChannel'
```

**原因**：
- `relay_control.c` 未添加到Keil项目中

**解决方案**：
1. 打开Keil项目
2. 右键 `Application/User` 或 `Core` 组
3. 添加 `relay_control.c` 文件

---

### 问题2：状态反馈始终显示ERROR

**现象**：
```
Relay1: ERROR | STA=0
```

**原因**：
- 状态反馈引脚未连接或连接错误
- 继电器实际状态与预期不符

**解决方案**：
1. 检查状态反馈引脚连接
2. 确认继电器动作正常（听声音、看指示灯）
3. 如果只做软件测试，可忽略此错误（状态反馈未接）

---

### 问题3：互锁失效，可以同时打开多个通道

**现象**：
```
WARNING: Interlock failed! CH3 was opened
```

**原因**：
- `Relay_OpenChannel()` 互锁逻辑未生效
- `relay_manager.active_channel` 更新异常

**解决方案**：
1. 检查 `relay_control.c` 中的 `Relay_OpenChannel()` 函数
2. 确认互锁判断逻辑：
   ```c
   if (relay_manager.active_channel != CHANNEL_NONE && 
       relay_manager.active_channel != channel)
   {
       return false;  // 拒绝操作
   }
   ```

---

### 问题4：500ms脉冲时间不准

**现象**：
- 示波器测量脉冲宽度不是500ms

**原因**：
- `HAL_Delay()` 时间不准确
- `Relay_Update()` 调用频率不足

**解决方案**：
1. 确认 `RELAY_PULSE_WIDTH` 定义为500
2. 在脉冲期间必须持续调用 `Relay_Update()`（如测试代码中60ms×10次循环）
3. 不要在脉冲期间长时间阻塞

---

### 问题5：使能中断不响应

**现象**：
- K1_EN/K2_EN/K3_EN 引脚电平变化，但无任何反应

**原因**：
- 中断未配置或被禁用
- `HAL_GPIO_EXTI_Callback()` 未正确调用

**解决方案**：
1. 检查 `stm32f1xx_it.c` 中 `HAL_GPIO_EXTI_Callback()` 是否正确添加：
   ```c
   else if (GPIO_Pin == K1_EN_Pin)
   {
       Relay_K1_EN_ISR();
   }
   ```
2. 确认CubeMX配置中使能了对应的EXTI中断（PB9/PB8/PA15）
3. 检查中断优先级是否被其他中断屏蔽

---

## 完整测试输出示例

```
========== Phase 7 Test ==========
Testing relay control module (Cycle Mode)...

[Relay] Module initialized
[Relay] All channels closed (interlock enabled)
[Relay] Pulse width: 500ms
[Relay] Debounce: 50ms x 3 times

========== Relay Cycle Test (Loop) ==========

[Cycle] Opening Channel 1...
[Relay] Opening CH1...
  -> CH1 relay activated, waiting 2s...
[Cycle] Closing Channel 1...
[Relay] Closing CH1...
  -> CH1 relay deactivated, waiting 1s...

[Cycle] Opening Channel 2...
[Relay] Opening CH2...
  -> CH2 relay activated, waiting 2s...
[Cycle] Closing Channel 2...
[Relay] Closing CH2...
  -> CH2 relay deactivated, waiting 1s...

[Cycle] Opening Channel 3...
[Relay] Opening CH3...
  -> CH3 relay activated, waiting 2s...
[Cycle] Closing Channel 3...
[Relay] Closing CH3...
  -> CH3 relay deactivated, waiting 1s...

--- Loop completed, restarting... ---

[Cycle] Opening Channel 1...
[Relay] Opening CH1...
  -> CH1 relay activated, waiting 2s...
[Cycle] Closing Channel 1...
[Relay] Closing CH1...
  -> CH1 relay deactivated, waiting 1s...

[Cycle] Opening Channel 2...
[Relay] Opening CH2...
  -> CH2 relay activated, waiting 2s...
...

(循环持续，直到断电或复位)
```

**说明**：
- 串口会持续输出循环信息
- 每9秒完成一个完整循环（3个通道）
- 物理继电器会同步动作（听到咔咔声）
- 可以随时按复位键重新开始测试

---

## 最终验收清单

| 序号 | 测试项 | 验收标准 | 检查方法 | 状态 |
|------|--------|----------|----------|------|
| 1 | 编译通过 | 0 Error, 0 Warning | Keil编译 | ✅ |
| 2 | 初始化正常 | 串口输出初始化信息，所有引脚高电平 | 串口 + 万用表 | ⬜ |
| 3 | 循环测试运行 | 自动进入循环，每9秒一轮 | 串口 + 计时 | ⬜ |
| 4 | 通道1动作 | K1.1、K1.2打开/关闭正常 | 听声音 | ⬜ |
| 5 | 通道2动作 | K2.1、K2.2打开/关闭正常 | 听声音 | ⬜ |
| 6 | 通道3动作 | K3.1、K3.2打开/关闭正常 | 听声音 | ⬜ |
| 7 | 低脉冲特性 | 500ms低电平脉冲 | 示波器 | ⬜ |
| 8 | 静态高电平 | 非触发时保持高电平 | 示波器 | ⬜ |
| 9 | 磁保持特性 | 脉冲结束后继电器保持状态 | 物理观察 | ⬜ |
| 10 | 状态反馈 | STA引脚反映实际状态（如已接） | 串口 | ⬜ |

---

## 下一步

完成阶段7测试后，进入**阶段8：安全监控系统**开发。
