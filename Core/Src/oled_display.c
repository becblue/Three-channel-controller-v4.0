/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : oled_display.c
  * @brief          : OLED display driver implementation (SSD1309)
  * @author         : Three-channel Controller Team
  * @date           : 2026-02-13
  ******************************************************************************
  */
/* USER CODE END Header */

/* Includes ------------------------------------------------------------------*/
#include "oled_display.h"
#include "i2c.h"
#include "usart.h"
#include <string.h>
#include <stdio.h>
#include <stdlib.h>

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
#define OLED_CMD_MODE   0x00
#define OLED_DATA_MODE  0x40
#define OLED_TIMEOUT    100

/* Private variables ---------------------------------------------------------*/

static uint8_t oled_buffer[OLED_WIDTH * OLED_PAGES];

/* Private function prototypes -----------------------------------------------*/
static bool oled_write_cmd(uint8_t cmd);
static bool oled_write_data(uint8_t *data, uint16_t len);

/* ==================== 6x8 Font (ASCII 0x20~0x7E, 95 chars) ==================== */
static const uint8_t font_6x8[][6] = {
    {0x00,0x00,0x00,0x00,0x00,0x00}, // 0x20 ' '
    {0x00,0x00,0x5F,0x00,0x00,0x00}, // 0x21 '!'
    {0x00,0x07,0x00,0x07,0x00,0x00}, // 0x22 '"'
    {0x14,0x7F,0x14,0x7F,0x14,0x00}, // 0x23 '#'
    {0x24,0x2A,0x7F,0x2A,0x12,0x00}, // 0x24 '$'
    {0x23,0x13,0x08,0x64,0x62,0x00}, // 0x25 '%'
    {0x36,0x49,0x55,0x22,0x50,0x00}, // 0x26 '&'
    {0x00,0x05,0x03,0x00,0x00,0x00}, // 0x27 '\''
    {0x00,0x1C,0x22,0x41,0x00,0x00}, // 0x28 '('
    {0x00,0x41,0x22,0x1C,0x00,0x00}, // 0x29 ')'
    {0x14,0x08,0x3E,0x08,0x14,0x00}, // 0x2A '*'
    {0x08,0x08,0x3E,0x08,0x08,0x00}, // 0x2B '+'
    {0x00,0x50,0x30,0x00,0x00,0x00}, // 0x2C ','
    {0x08,0x08,0x08,0x08,0x08,0x00}, // 0x2D '-'
    {0x00,0x60,0x60,0x00,0x00,0x00}, // 0x2E '.'
    {0x20,0x10,0x08,0x04,0x02,0x00}, // 0x2F '/'
    {0x3E,0x51,0x49,0x45,0x3E,0x00}, // 0x30 '0'
    {0x00,0x42,0x7F,0x40,0x00,0x00}, // 0x31 '1'
    {0x42,0x61,0x51,0x49,0x46,0x00}, // 0x32 '2'
    {0x21,0x41,0x45,0x4B,0x31,0x00}, // 0x33 '3'
    {0x18,0x14,0x12,0x7F,0x10,0x00}, // 0x34 '4'
    {0x27,0x45,0x45,0x45,0x39,0x00}, // 0x35 '5'
    {0x3C,0x4A,0x49,0x49,0x30,0x00}, // 0x36 '6'
    {0x01,0x71,0x09,0x05,0x03,0x00}, // 0x37 '7'
    {0x36,0x49,0x49,0x49,0x36,0x00}, // 0x38 '8'
    {0x06,0x49,0x49,0x29,0x1E,0x00}, // 0x39 '9'
    {0x00,0x36,0x36,0x00,0x00,0x00}, // 0x3A ':'
    {0x00,0x56,0x36,0x00,0x00,0x00}, // 0x3B ';'
    {0x08,0x14,0x22,0x41,0x00,0x00}, // 0x3C '<'
    {0x14,0x14,0x14,0x14,0x14,0x00}, // 0x3D '='
    {0x00,0x41,0x22,0x14,0x08,0x00}, // 0x3E '>'
    {0x02,0x01,0x51,0x09,0x06,0x00}, // 0x3F '?'
    {0x32,0x49,0x79,0x41,0x3E,0x00}, // 0x40 '@'
    {0x7E,0x11,0x11,0x11,0x7E,0x00}, // 0x41 'A'
    {0x7F,0x49,0x49,0x49,0x36,0x00}, // 0x42 'B'
    {0x3E,0x41,0x41,0x41,0x22,0x00}, // 0x43 'C'
    {0x7F,0x41,0x41,0x22,0x1C,0x00}, // 0x44 'D'
    {0x7F,0x49,0x49,0x49,0x41,0x00}, // 0x45 'E'
    {0x7F,0x09,0x09,0x09,0x01,0x00}, // 0x46 'F'
    {0x3E,0x41,0x49,0x49,0x7A,0x00}, // 0x47 'G'
    {0x7F,0x08,0x08,0x08,0x7F,0x00}, // 0x48 'H'
    {0x00,0x41,0x7F,0x41,0x00,0x00}, // 0x49 'I'
    {0x20,0x40,0x41,0x3F,0x01,0x00}, // 0x4A 'J'
    {0x7F,0x08,0x14,0x22,0x41,0x00}, // 0x4B 'K'
    {0x7F,0x40,0x40,0x40,0x40,0x00}, // 0x4C 'L'
    {0x7F,0x02,0x0C,0x02,0x7F,0x00}, // 0x4D 'M'
    {0x7F,0x04,0x08,0x10,0x7F,0x00}, // 0x4E 'N'
    {0x3E,0x41,0x41,0x41,0x3E,0x00}, // 0x4F 'O'
    {0x7F,0x09,0x09,0x09,0x06,0x00}, // 0x50 'P'
    {0x3E,0x41,0x51,0x21,0x5E,0x00}, // 0x51 'Q'
    {0x7F,0x09,0x19,0x29,0x46,0x00}, // 0x52 'R'
    {0x46,0x49,0x49,0x49,0x31,0x00}, // 0x53 'S'
    {0x01,0x01,0x7F,0x01,0x01,0x00}, // 0x54 'T'
    {0x3F,0x40,0x40,0x40,0x3F,0x00}, // 0x55 'U'
    {0x1F,0x20,0x40,0x20,0x1F,0x00}, // 0x56 'V'
    {0x3F,0x40,0x38,0x40,0x3F,0x00}, // 0x57 'W'
    {0x63,0x14,0x08,0x14,0x63,0x00}, // 0x58 'X'
    {0x07,0x08,0x70,0x08,0x07,0x00}, // 0x59 'Y'
    {0x61,0x51,0x49,0x45,0x43,0x00}, // 0x5A 'Z'
    {0x00,0x08,0x36,0x41,0x00,0x00}, // 0x5B '['
    {0x00,0x00,0x7F,0x00,0x00,0x00}, // 0x5C '\'
    {0x00,0x41,0x36,0x08,0x00,0x00}, // 0x5D ']'
    {0x04,0x02,0x01,0x02,0x04,0x00}, // 0x5E '^'
    {0x40,0x40,0x40,0x40,0x40,0x00}, // 0x5F '_'
    {0x00,0x01,0x02,0x04,0x00,0x00}, // 0x60 '`'
    {0x20,0x54,0x54,0x54,0x78,0x00}, // 0x61 'a'
    {0x7F,0x48,0x44,0x44,0x38,0x00}, // 0x62 'b'
    {0x38,0x44,0x44,0x44,0x20,0x00}, // 0x63 'c'
    {0x38,0x44,0x44,0x48,0x7F,0x00}, // 0x64 'd'
    {0x38,0x54,0x54,0x54,0x18,0x00}, // 0x65 'e'
    {0x08,0x7E,0x09,0x01,0x02,0x00}, // 0x66 'f'
    {0x0C,0x52,0x52,0x52,0x3E,0x00}, // 0x67 'g'
    {0x7F,0x08,0x04,0x04,0x78,0x00}, // 0x68 'h'
    {0x00,0x44,0x7D,0x40,0x00,0x00}, // 0x69 'i'
    {0x20,0x40,0x44,0x3D,0x00,0x00}, // 0x6A 'j'
    {0x7F,0x10,0x28,0x44,0x00,0x00}, // 0x6B 'k'
    {0x00,0x41,0x7F,0x40,0x00,0x00}, // 0x6C 'l'
    {0x7C,0x04,0x18,0x04,0x78,0x00}, // 0x6D 'm'
    {0x7C,0x08,0x04,0x04,0x78,0x00}, // 0x6E 'n'
    {0x38,0x44,0x44,0x44,0x38,0x00}, // 0x6F 'o'
    {0x7C,0x14,0x14,0x14,0x08,0x00}, // 0x70 'p'
    {0x08,0x14,0x14,0x18,0x7C,0x00}, // 0x71 'q'
    {0x7C,0x08,0x04,0x04,0x08,0x00}, // 0x72 'r'
    {0x48,0x54,0x54,0x54,0x20,0x00}, // 0x73 's'
    {0x04,0x3F,0x44,0x40,0x20,0x00}, // 0x74 't'
    {0x3C,0x40,0x40,0x20,0x7C,0x00}, // 0x75 'u'
    {0x1C,0x20,0x40,0x20,0x1C,0x00}, // 0x76 'v'
    {0x3C,0x40,0x30,0x40,0x3C,0x00}, // 0x77 'w'
    {0x44,0x28,0x10,0x28,0x44,0x00}, // 0x78 'x'
    {0x0C,0x50,0x50,0x50,0x3C,0x00}, // 0x79 'y'
    {0x44,0x64,0x54,0x4C,0x44,0x00}, // 0x7A 'z'
    {0x00,0x08,0x36,0x41,0x00,0x00}, // 0x7B '{'
    {0x00,0x00,0x7F,0x00,0x00,0x00}, // 0x7C '|'
    {0x00,0x41,0x36,0x08,0x00,0x00}, // 0x7D '}'
    {0x10,0x08,0x08,0x10,0x08,0x00}, // 0x7E '~'
};

/* ==================== 8x16 Font (ASCII 0x20~0x7E, upper+lower half) ==================== */
/* Note: lower-case letters (0x61~0x7A) not included; use upper-case for 8x16 strings     */
static const uint8_t font_8x16[][16] = {
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // ' '
{0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x00,0x00,0x00,0x00}, // '!'
{0x00,0x10,0x0C,0x02,0x10,0x0C,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // '"'
{0x00,0x40,0xC0,0x78,0x40,0xC0,0x78,0x00,0x00,0x04,0x3F,0x04,0x04,0x3F,0x04,0x00}, // '#'
{0x00,0x70,0x88,0x88,0xFC,0x08,0x30,0x00,0x00,0x18,0x20,0x20,0xFF,0x21,0x1E,0x00}, // '$'
{0xF0,0x08,0xF0,0x80,0x60,0x18,0x00,0x00,0x00,0x31,0x0C,0x03,0x1E,0x21,0x1E,0x00}, // '%'
{0x00,0xF0,0x08,0x88,0x70,0x00,0x00,0x00,0x1E,0x21,0x23,0x2C,0x19,0x27,0x21,0x10}, // '&'
{0x00,0x12,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // '\''
{0x00,0x00,0x00,0xE0,0x18,0x04,0x02,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00}, // '('
{0x00,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00}, // ')'
{0x40,0x40,0x80,0xF0,0x80,0x40,0x40,0x00,0x02,0x02,0x01,0x0F,0x01,0x02,0x02,0x00}, // '*'
{0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x0F,0x01,0x01,0x01}, // '+'
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x90,0x70,0x00,0x00,0x00,0x00,0x00}, // ','
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x00}, // '-'
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00}, // '.'
{0x00,0x00,0x00,0x00,0xC0,0x38,0x04,0x00,0x00,0x60,0x18,0x07,0x00,0x00,0x00,0x00}, // '/'
{0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00}, // '0'
{0x00,0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00}, // '1'
{0x00,0x70,0x08,0x08,0x08,0x08,0xF0,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00}, // '2'
{0x00,0x30,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x18,0x20,0x21,0x21,0x22,0x1C,0x00}, // '3'
{0x00,0x00,0x80,0x40,0x30,0xF8,0x00,0x00,0x00,0x06,0x05,0x24,0x24,0x3F,0x24,0x24}, // '4'
{0x00,0xF8,0x88,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x20,0x20,0x20,0x11,0x0E,0x00}, // '5'
{0x00,0xE0,0x10,0x88,0x88,0x90,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x20,0x1F,0x00}, // '6'
{0x00,0x18,0x08,0x08,0x88,0x68,0x18,0x00,0x00,0x00,0x00,0x3E,0x01,0x00,0x00,0x00}, // '7'
{0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00}, // '8'
{0x00,0xF0,0x08,0x08,0x08,0x10,0xE0,0x00,0x00,0x01,0x12,0x22,0x22,0x11,0x0F,0x00}, // '9'
{0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00}, // ':'
{0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x00}, // ';'
{0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00}, // '<'
{0x00,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x00,0x02,0x02,0x02,0x02,0x02,0x02,0x00}, // '='
{0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x01,0x00}, // '>'
{0x00,0x70,0x48,0x08,0x08,0x88,0x70,0x00,0x00,0x00,0x00,0x30,0x37,0x00,0x00,0x00}, // '?'
{0xC0,0x30,0xC8,0x28,0xE8,0x10,0xE0,0x00,0x07,0x18,0x27,0x28,0x2F,0x28,0x17,0x00}, // '@'
{0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20}, // 'A'
{0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00}, // 'B'
{0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00}, // 'C'
{0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00}, // 'D'
{0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00}, // 'E'
{0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00}, // 'F'
{0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00}, // 'G'
{0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20}, // 'H'
{0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00}, // 'I'
{0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00}, // 'J'
{0x08,0xF8,0x00,0x00,0x80,0x80,0x80,0x00,0x20,0x3F,0x24,0x02,0x2D,0x30,0x20,0x00}, // 'K'
{0x00,0x08,0x08,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00}, // 'L'
{0x08,0xF8,0xF8,0x00,0xF8,0xF8,0x08,0x00,0x20,0x3F,0x01,0x3E,0x01,0x3F,0x20,0x00}, // 'M'
{0x08,0xF8,0x30,0xC0,0x00,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x07,0x18,0x3F,0x00}, // 'N'
{0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00}, // 'O'
{0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00}, // 'P'
{0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x28,0x28,0x30,0x50,0x4F,0x00}, // 'Q'
{0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20}, // 'R'
{0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00}, // 'S'
{0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00}, // 'T'
{0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00}, // 'U'
{0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00}, // 'V'
{0x08,0xF8,0x00,0xF8,0x00,0xF8,0x08,0x00,0x00,0x03,0x3E,0x01,0x3E,0x03,0x00,0x00}, // 'W'
{0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20}, // 'X'
{0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00}, // 'Y'
{0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x38,0x26,0x21,0x20,0x20,0x18,0x00}, // 'Z'
{0x00,0x00,0x00,0x00,0x80,0x7C,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x3F,0x40,0x40}, // '{'
{0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00}, // '|'
{0x00,0x02,0x02,0x7C,0x80,0x00,0x00,0x00,0x00,0x40,0x40,0x3F,0x00,0x00,0x00,0x00}, // '}'
{0x00,0x06,0x01,0x03,0x02,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // '~'
};

/* ==================== Customer LOGO bitmap (128x27 px, row-scan) ==================== */
static const uint8_t logo_data[27][16] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC},
    {0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC},
    {0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC},
    {0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC},
    {0x1F,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x3F,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x3F,0xFF,0x80,0x01,0xFF,0x01,0xE7,0x3C,0x3C,0x0F,0x0F,0x00,0x7F,0xF8,0x7F,0xC0},
    {0x7F,0xFF,0x00,0x03,0xFF,0xC1,0xE7,0x7C,0x7C,0x0F,0x0F,0x00,0x7F,0xF8,0x7F,0xF8},
    {0x7F,0xFF,0x00,0x03,0xFF,0xE1,0xE6,0x7C,0x7C,0x0F,0x0F,0x00,0x7F,0xF8,0x7F,0xF8},
    {0x7F,0xFE,0x00,0x03,0xFF,0xE1,0xE6,0x78,0x78,0x1F,0x1F,0x00,0x7F,0xF8,0x7F,0xFC},
    {0x7F,0xFE,0x00,0x03,0xC3,0xE3,0xE6,0x78,0x78,0x1F,0x1F,0x00,0x78,0x00,0xF8,0x7C},
    {0xFF,0xFE,0x00,0x03,0xC1,0xE3,0xEE,0x78,0x78,0x1F,0x1F,0x00,0x78,0x00,0xF8,0x3C},
    {0x7F,0xFE,0x00,0x03,0xC3,0xC3,0xE0,0x78,0x78,0x1E,0x1E,0x00,0xF8,0x00,0xF8,0x3C},
    {0x7F,0xFE,0x00,0x03,0xFF,0xC3,0xC0,0xF8,0xFF,0xFE,0x1E,0x00,0xFF,0xF0,0xF0,0x7C},
    {0x7F,0xFE,0x00,0x07,0xFF,0x03,0xC0,0xF8,0xFF,0xFE,0x1E,0x00,0xFF,0xF0,0xFF,0xF8},
    {0x7F,0xFE,0x00,0x07,0xFF,0x83,0xC0,0xF8,0xFF,0xFE,0x1E,0x00,0xFF,0xE0,0xFF,0xF0},
    {0x3F,0xFF,0x00,0x07,0xC7,0xC3,0xC0,0xF0,0xFF,0xFE,0x3E,0x00,0xFB,0xE0,0xFF,0xE0},
    {0x3F,0xFF,0x80,0x07,0x83,0xC3,0xC0,0xF0,0xF0,0x3E,0x3E,0x00,0xF0,0x01,0xFF,0xC0},
    {0x1F,0xFF,0x80,0x07,0x83,0xC3,0xC1,0xF0,0xF0,0x3E,0x3E,0x00,0xF0,0x01,0xF3,0xE0},
    {0x0F,0xFF,0xE0,0x07,0x87,0xC3,0xF3,0xE0,0xF0,0x3C,0x3F,0xF9,0xFF,0xE1,0xF3,0xE0},
    {0x07,0xFF,0xF8,0x07,0xFF,0xC3,0xFF,0xE1,0xF0,0x3C,0x3F,0xF9,0xFF,0xE1,0xE1,0xF0},
    {0x01,0xFF,0xF8,0x0F,0xFF,0x81,0xFF,0xC1,0xF0,0x3C,0x3F,0xF9,0xFF,0xE1,0xE1,0xF0},
    {0x00,0x7F,0xF8,0x0F,0xFF,0x00,0xFF,0x81,0xF0,0x7C,0x3F,0xF9,0xFF,0xE1,0xE0,0xF8},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

/* ==================== Minyer LOGO (115x27 px, Image2Lcd row-scan, skip 6-byte header) ==================== */
static const uint8_t gImage_minyerlogo[411] = {
0X00,0X01,0X73,0X00,0X1B,0X00,
0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X1C,
0X00,0X0C,0X08,0X30,0X00,0X63,0X00,0X00,0XC0,0X00,0X00,0X00,0X00,0X1F,0X3E,0X00,
0X1F,0X0C,0X78,0X00,0X63,0X80,0X01,0XCF,0XFF,0XF1,0XFF,0XFC,0X00,0X36,0X00,0X3F,
0X0C,0X7C,0X00,0X61,0X80,0X01,0X8F,0XFF,0XF1,0XFF,0XFE,0X00,0X33,0X00,0X33,0X0C,
0X6C,0X00,0X60,0XC0,0X03,0X8C,0X00,0X01,0X80,0X07,0X1F,0X33,0X00,0X33,0X0C,0X6E,
0X00,0X60,0XC0,0X07,0X0C,0X00,0X01,0X80,0X03,0X00,0X33,0X00,0X63,0X0C,0X66,0X00,
0X60,0X60,0X06,0X0C,0X00,0X01,0X80,0X03,0X80,0X33,0X80,0X63,0X0C,0X67,0X00,0X60,
0X20,0X0E,0X0C,0X00,0X01,0X80,0X01,0X80,0X31,0X80,0X63,0X0C,0X63,0X00,0X60,0X30,
0X1C,0X0C,0X00,0X01,0X80,0X01,0X9F,0X31,0X80,0XE3,0X0C,0X63,0X80,0X60,0X38,0X18,
0X0C,0X00,0X01,0X80,0X01,0X80,0X31,0XC0,0XC3,0X0C,0X61,0X80,0X60,0X18,0X38,0X0C,
0X00,0X01,0X80,0X03,0X8E,0X30,0XC0,0XC3,0X0C,0X61,0XC0,0X60,0X1C,0X70,0X0C,0X00,
0X01,0X80,0X03,0X00,0X30,0XC0,0XC3,0X0C,0X60,0XC0,0X60,0X0E,0X60,0X0C,0X00,0X01,
0X80,0X0F,0X1F,0X30,0XC1,0X83,0X0C,0X60,0XE0,0X60,0X06,0XE0,0X0C,0XFF,0XE1,0XBF,
0XFE,0X00,0X30,0X61,0X83,0X0C,0X60,0X70,0X60,0X03,0X80,0X0C,0X00,0X01,0X80,0X00,
0X18,0X30,0X63,0X83,0X0C,0X60,0X30,0X60,0X00,0X00,0X0C,0X00,0X01,0X80,0X30,0X00,
0X30,0X73,0X03,0X0C,0X60,0X38,0X60,0X01,0X00,0X0C,0X00,0X01,0X80,0X38,0X01,0X30,
0X33,0X03,0X0C,0X60,0X18,0X60,0X01,0X80,0X0C,0X00,0X01,0X80,0X18,0X04,0X30,0X37,
0X03,0X0C,0X60,0X1C,0X60,0X01,0X80,0X0C,0X00,0X01,0X80,0X0C,0X10,0X30,0X36,0X03,
0X0C,0X60,0X0C,0X60,0X01,0X80,0X0C,0X00,0X01,0X80,0X0E,0X00,0X30,0X16,0X03,0X0C,
0X60,0X0E,0X60,0X01,0X80,0X0C,0X00,0X01,0X80,0X06,0X00,0X30,0X1E,0X03,0X0C,0X60,
0X06,0X60,0X01,0X80,0X0C,0X00,0X01,0X80,0X07,0X04,0X30,0X1C,0X03,0X0C,0X60,0X07,
0X60,0X01,0X80,0X0C,0X00,0X01,0X80,0X03,0X10,0X30,0X1C,0X03,0X0C,0X60,0X03,0XE0,
0X01,0X80,0X0F,0XFF,0XF9,0X80,0X01,0X80,0X30,0X00,0X03,0X0C,0X60,0X03,0XE0,0X01,
0X80,0X07,0XFF,0XF9,0X80,0X01,0X9C,0X20,0X00,0X02,0X08,0X20,0X00,0X00,0X01,0X00,
0X00,0X00,0X01,0X00,0X00,0X80,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,0X00,
0X00,0X00,0X00,0X00,0X00,
};

/* Exported functions --------------------------------------------------------*/

bool OLED_Init(void)
{
    printf("[OLED] Initializing display...\r\n");

    HAL_Delay(100);

    oled_write_cmd(0xAE);
    oled_write_cmd(0xD5);
    oled_write_cmd(0x80);
    oled_write_cmd(0xA8);
    oled_write_cmd(0x3F);
    oled_write_cmd(0xD3);
    oled_write_cmd(0x00);
    oled_write_cmd(0x40);
    oled_write_cmd(0x8D);
    oled_write_cmd(0x14);
    oled_write_cmd(0x20);
    oled_write_cmd(0x00);
    oled_write_cmd(0xA1);
    oled_write_cmd(0xC8);
    oled_write_cmd(0xDA);
    oled_write_cmd(0x12);
    oled_write_cmd(0x81);
    oled_write_cmd(0xCF);
    oled_write_cmd(0xD9);
    oled_write_cmd(0xF1);
    oled_write_cmd(0xDB);
    oled_write_cmd(0x40);
    oled_write_cmd(0xA4);
    oled_write_cmd(0xA6);
    oled_write_cmd(0xAF);

    memset(oled_buffer, 0, sizeof(oled_buffer));
    OLED_Refresh();

    printf("[OLED] Initialization complete\r\n");
    return true;
}

void OLED_Clear(void)
{
    memset(oled_buffer, 0, sizeof(oled_buffer));
}

void OLED_ClearArea(OLED_Area_e area)
{
    uint8_t start_page, end_page;

    switch (area) {
        case OLED_AREA_ALARM:
            start_page = OLED_AREA_ALARM_START;
            end_page   = OLED_AREA_ALARM_END;
            break;
        case OLED_AREA_CHANNEL:
            start_page = OLED_AREA_CHANNEL_START;
            end_page   = OLED_AREA_CHANNEL_END;
            break;
        case OLED_AREA_TEMP:
            start_page = OLED_AREA_TEMP_START;
            end_page   = OLED_AREA_TEMP_END;
            break;
        default:
            return;
    }

    for (uint8_t page = start_page; page <= end_page; page++) {
        memset(&oled_buffer[page * OLED_WIDTH], 0, OLED_WIDTH);
    }
}

void OLED_DrawPixel(uint8_t x, uint8_t y, bool on)
{
    if (x >= OLED_WIDTH || y >= OLED_HEIGHT) return;

    uint8_t  page = y / 8U;
    uint8_t  bit  = y % 8U;
    uint16_t idx  = (uint16_t)page * OLED_WIDTH + x;

    if (on) {
        oled_buffer[idx] |= (uint8_t)(1U << bit);
    } else {
        oled_buffer[idx] &= (uint8_t)(~(1U << bit));
    }
}

void OLED_DrawLine(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2)
{
    int16_t dx  = abs(x2 - x1);
    int16_t dy  = abs(y2 - y1);
    int16_t sx  = (x1 < x2) ? 1 : -1;
    int16_t sy  = (y1 < y2) ? 1 : -1;
    int16_t err = dx - dy;

    while (1) {
        OLED_DrawPixel(x1, y1, true);
        if (x1 == x2 && y1 == y2) break;
        int16_t e2 = 2 * err;
        if (e2 > -dy) { err -= dy; x1 += (uint8_t)sx; }
        if (e2 <  dx) { err += dx; y1 += (uint8_t)sy; }
    }
}

void OLED_DrawRect(uint8_t x, uint8_t y, uint8_t width, uint8_t height, bool filled)
{
    if (filled) {
        for (uint8_t i = 0; i < height; i++) {
            for (uint8_t j = 0; j < width; j++) {
                OLED_DrawPixel(x + j, y + i, true);
            }
        }
    } else {
        OLED_DrawLine(x,             y,            x + width - 1U, y            );
        OLED_DrawLine(x,             y + height - 1U, x + width - 1U, y + height - 1U);
        OLED_DrawLine(x,             y,            x,              y + height - 1U);
        OLED_DrawLine(x + width - 1U, y,           x + width - 1U, y + height - 1U);
    }
}

void OLED_ShowChar(uint8_t x, uint8_t y, char ch, OLED_Font_e font)
{
    if (ch < ' ' || ch > '~') return;

    uint8_t char_idx = (uint8_t)(ch - ' ');

    if (font == OLED_FONT_6X8)
    {
        if (y >= OLED_PAGES || x >= OLED_WIDTH) return;
        for (uint8_t i = 0U; i < 6U; i++) {
            if ((x + i) < OLED_WIDTH) {
                oled_buffer[(uint16_t)y * OLED_WIDTH + x + i] = font_6x8[char_idx][i];
            }
        }
    }
    else if (font == OLED_FONT_8X16)
    {
        /* font_8x16 covers ' '(0)~'Z'(58) then '{'(59)~'~'(62); remap for skipped range */
        uint8_t f_idx;
        if (ch >= ' ' && ch <= 'Z') {
            f_idx = char_idx;             /* indices 0~58 */
        } else if (ch >= '{' && ch <= '~') {
            f_idx = (uint8_t)(59U + (uint8_t)(ch - '{')); /* indices 59~62 */
        } else {
            f_idx = 0U;                   /* unsupported char: show space */
        }

        if ((y + 1U) >= OLED_PAGES || x >= OLED_WIDTH) return;
        for (uint8_t i = 0U; i < 8U; i++) {
            if ((x + i) < OLED_WIDTH) {
                oled_buffer[(uint16_t)y       * OLED_WIDTH + x + i] = font_8x16[f_idx][i];
                oled_buffer[(uint16_t)(y + 1U) * OLED_WIDTH + x + i] = font_8x16[f_idx][8U + i];
            }
        }
    }
}

void OLED_ShowString(uint8_t x, uint8_t y, const char *str, OLED_Font_e font)
{
    uint8_t pos_x  = x;
    uint8_t char_w = (font == OLED_FONT_8X16) ? 8U : 6U;

    while (*str != '\0') {
        if (pos_x >= OLED_WIDTH) break;
        OLED_ShowChar(pos_x, y, *str, font);
        pos_x += char_w;
        str++;
    }
}

void OLED_ShowNum(uint8_t x, uint8_t y, int32_t num, uint8_t len, OLED_Font_e font)
{
    char str[12];
    snprintf(str, sizeof(str), "%*d", (int)len, (int)num);
    OLED_ShowString(x, y, str, font);
}

/**
 * @brief Customer LOGO (128x27 px row-scan bitmap, vertically centered)
 */
void OLED_ShowLogo(void)
{
    OLED_Clear();

    /* Vertically center 27-pixel-high image in 64-pixel screen: y_start = (64-27)/2 = 18 */
    const uint8_t y_start = 18U;

    for (uint8_t row = 0U; row < 27U; row++) {
        for (uint8_t col = 0U; col < 128U; col++) {
            bool pix = ((logo_data[row][col >> 3U] >> (7U - (col & 7U))) & 0x01U) != 0U;
            OLED_DrawPixel(col, y_start + row, pix);
        }
    }

    OLED_Refresh();
}

/**
 * @brief Minyer LOGO (115x27 px, Image2Lcd row-scan, 6-byte header skipped)
 *        Displayed in self-test screen row1~4 (y=8~39), both axes centered.
 */
void OLED_ShowMinyerLogo(void)
{
    /* Image geometry */
    const uint8_t LOGO_W     = 115U;
    const uint8_t LOGO_H     = 27U;
    const uint8_t BYTES_ROW  = 15U;   /* ceil(115/8) = 15 bytes per row */
    const uint8_t HDR        = 6U;    /* Image2Lcd header size */

    /* Placement: horizontal center, vertical center within row1~4 (y=8..39, 32px) */
    const uint8_t x_start = (uint8_t)((128U - LOGO_W) / 2U);     /* = 6  */
    const uint8_t y_start = (uint8_t)(8U + (32U - LOGO_H) / 2U); /* = 10 */

    for (uint8_t row = 0U; row < LOGO_H; row++) {
        for (uint8_t col = 0U; col < LOGO_W; col++) {
            bool pix = ((gImage_minyerlogo[HDR + row * BYTES_ROW + (col >> 3U)]
                         >> (7U - (col & 7U))) & 0x01U) != 0U;
            OLED_DrawPixel(x_start + col, y_start + row, pix);
        }
    }
}

/**
 * @brief Progress bar for self-test (row5~6, y=40~55). Does NOT clear whole screen.
 *        Only clears row5~6 then redraws bar + percentage.
 */
void OLED_ShowProgress(uint8_t percent)
{
    if (percent > 100U) percent = 100U;

    /* Clear progress area only (page 5~6) */
    memset(&oled_buffer[5U * OLED_WIDTH], 0U, (size_t)OLED_WIDTH * 2U);

    /* Outer frame: x=10, y=41, w=108, h=10 */
    OLED_DrawRect(10U, 41U, 108U, 10U, false);

    /* Fill: inner area x=11, y=42, max_w=106 */
    uint8_t fill = (uint8_t)((106U * (uint16_t)percent) / 100U);
    if (fill > 0U) {
        OLED_DrawRect(11U, 42U, fill, 8U, true);
    }

    /* Percentage text, centered on row6 (y=48~55) */
    char    str[8];
    snprintf(str, sizeof(str), "%d%%", percent);
    uint8_t tlen = (uint8_t)strlen(str);
    uint8_t tx   = (uint8_t)((128U - (uint16_t)tlen * 6U) / 2U);
    OLED_ShowString(tx, 6U, str, OLED_FONT_6X8);
}

void OLED_Refresh(void)
{
    oled_write_cmd(0x21);
    oled_write_cmd(0);
    oled_write_cmd(127);
    oled_write_cmd(0x22);
    oled_write_cmd(0);
    oled_write_cmd(7);
    oled_write_data(oled_buffer, sizeof(oled_buffer));
}

void OLED_DisplayOn(bool on)
{
    oled_write_cmd(on ? 0xAFU : 0xAEU);
}

void OLED_SetBrightness(uint8_t brightness)
{
    oled_write_cmd(0x81);
    oled_write_cmd(brightness);
}

void OLED_Test(void)
{
    printf("[OLED] Running display test...\r\n");

    OLED_Clear();
    OLED_Refresh();
    HAL_Delay(500);

    OLED_Clear();
    OLED_DrawLine(0, 0, 127, 63);
    OLED_DrawLine(0, 63, 127, 0);
    OLED_DrawRect(10, 10, 108, 44, false);
    OLED_Refresh();
    HAL_Delay(1000);

    OLED_Clear();
    OLED_ShowString(0, 0, "OLED Test OK", OLED_FONT_6X8);
    OLED_ShowString(0, 2, "128x64 SSD1309", OLED_FONT_6X8);
    OLED_Refresh();
    HAL_Delay(2000);

    OLED_ShowLogo();
    HAL_Delay(2000);

    for (uint8_t i = 0; i <= 100U; i += 10U) {
        OLED_ShowProgress(i);
        OLED_Refresh();
        HAL_Delay(200);
    }

    printf("[OLED] Display test complete!\r\n");
}

/* Private functions ---------------------------------------------------------*/

static bool oled_write_cmd(uint8_t cmd)
{
    uint8_t data[2] = {OLED_CMD_MODE, cmd};
    return (HAL_I2C_Master_Transmit(&hi2c1, OLED_I2C_ADDRESS, data, 2, OLED_TIMEOUT) == HAL_OK);
}

static bool oled_write_data(uint8_t *data, uint16_t len)
{
    #define CHUNK_SIZE 32
    uint16_t sent = 0;

    while (sent < len) {
        uint16_t chunk = ((len - sent) > CHUNK_SIZE) ? CHUNK_SIZE : (len - sent);
        uint8_t  buf[CHUNK_SIZE + 1U];
        buf[0] = OLED_DATA_MODE;
        memcpy(&buf[1], &data[sent], chunk);
        if (HAL_I2C_Master_Transmit(&hi2c1, OLED_I2C_ADDRESS, buf, chunk + 1U, OLED_TIMEOUT) != HAL_OK) {
            return false;
        }
        sent += chunk;
    }
    return true;
}
